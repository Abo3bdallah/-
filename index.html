<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق القرعة العشوائية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* استيراد خط القاهرة من Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        /* الخلفية الرئيسية (ألوان زجاجية متدرجة) */
        .gradient-bg {
            background: linear-gradient(135deg, #00b5b5, #e07d51, #ffce18);
        }
        
        /* تأثيرات البطاقات */
        .card-hover {
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #fff;
        }

        /* متغيرات CSS للتحكم الديناميكي في الأحجام */
        :root {
            --pointer-size: 20px; 
            --number-circle-size: 250px; 
            --name-display-width: 60vw; 
            --name-display-height: 20vh; 
        }

        /* تنسيقات عجلة الحظ */
        .wheel-container {
            position: relative;
            width: min(85vw, 85vh); 
            height: min(85vw, 85vh); 
            margin: 0 auto;
            overflow: visible;
        }
        
        @media (max-width: 640px) {
            .wheel-container {
                width: min(95vw, 95vh); 
                height: min(95vw, 95vh); 
            }
        }
        
        .wheel {
            width: 100%; 
            height: 100%; 
            border-radius: 50%;
            transition: transform ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            cursor: grab; 
        }
        .wheel:active {
            cursor: grabbing;
        }

        /* المؤشر الجديد: خط مدبب يشير للأسفل (مثبت في الأعلى) */
        .pin-pointer {
            position: absolute;
            top: 0;
            left: 50%; 
            transform: translateX(calc(-50% + 10px)) translateY(calc(-1 * var(--pointer-size))); 
            z-index: 100;
            pointer-events: none;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid red; 
            transition: transform 0.1s ease;
        }

        /* المؤشر البصري لتحديد نقطة التوقف الدقيقة (طلب المستخدم) */
        .winning-pin {
            position: absolute;
            top: 0; /* في نفس موقع الـ pin-pointer */
            left: 50%;
            transform: translate(-50%, -100%) translateY(-25px); /* رفعها قليلاً لتكون فوق العجلة تماماً */
            width: 10px;
            height: 10px;
            background-color: #ff0000;
            border-radius: 50%;
            z-index: 101; /* أعلى من المؤشر ليكون واضحاً */
            pointer-events: none;
            box-shadow: 0 0 5px #ff0000;
        }

        /* الحركة الاهتزازية للمؤشر */
        .wobble {
            animation: wobbleAnim 0.15s ease-in-out infinite alternate;
            transform-origin: center bottom; 
        }

        @keyframes wobbleAnim {
            from { transform: translateX(calc(-50% + 10px)) translateY(calc(-1 * var(--pointer-size))) rotate(-5deg); }
            to { transform: translateX(calc(-50% + 10px)) translateY(calc(-1 * var(--pointer-size))) rotate(5deg); }
        }
        
        /* تأثيرات الأرقام */
        @keyframes numberPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* تنسيقات النرد */
        .dice-wrapper { perspective: 800px; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .dice-container { width: 100px; height: 100px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .dice-face {
            position: absolute; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); border: 2px solid #ccc;
            display: flex; align-items: center; justify-content: center; border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); font-size: 3rem; font-weight: bold; color: #333;
        }
        .dice-face.one { transform: rotateY(0deg) translateZ(50px); }
        .dice-face.two { transform: rotateX(90deg) translateZ(50px); }
        .dice-face.three { transform: rotateY(90deg) translateZ(50px); }
        .dice-face.four { transform: rotateY(-90deg) translateZ(50px); }
        .dice-face.five { transform: rotateX(-90deg) translateZ(50px); }
        .dice-face.six { transform: rotateY(180deg) translateZ(50px); }
        
        /* تنسيقات العملة */
        .coin-container { perspective: 1000px; }
        .coin {
            width: 128px; height: 128px; position: relative; transform-style: preserve-3d;
            transition: transform 3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .coin-face, .coin-side { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .coin-face img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .coin-front { transform: rotateY(0deg) translateZ(6px); }
        .coin-back { transform: rotateY(180deg) translateZ(6px); }
        .coin-side { width: 100%; height: 12px; background: linear-gradient(to right, #ccc, #f0f0f0, #ccc); top: 50%; left: 0; transform: translateY(-50%) rotateY(90deg) rotateX(90deg); border-radius: 0; z-index: -1; box-shadow: none; }
        
        /* تنسيق نوافذ الفرق (لترتيب الأسماء) */
        .team-red { background-color: rgba(220, 38, 38, 0.3); border-color: #dc2626; } 
        .team-blue { background-color: rgba(37, 99, 235, 0.3); border-color: #2563eb; }
        .team-green { background-color: rgba(16, 185, 129, 0.3); border-color: #10b981; }
        .team-yellow { background-color: rgba(251, 191, 36, 0.3); border-color: #fca51f; }
        .team-purple { background-color: rgba(168, 85, 247, 0.3); border-color: #a855f7; }
        .team-orange { background-color: rgba(249, 115, 22, 0.3); border-color: #f97316; }

        /* تنسيق الأزرار وعناصر القائمة المنسدلة في وضع Glass */
        .options-modal .modal-content select, .options-modal .modal-content textarea, .options-modal .modal-content input[type="number"] {
            color: #1f2937; 
            background-color: rgba(255, 255, 255, 0.8); 
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* تنسيق العنوان */
        .text-gradient {
            background-image: linear-gradient(to right, #ffffff, rgba(255, 255, 255, 0.7));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* تنسيقات نافذة الإدارة المنبثقة */
        .options-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 1500; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .options-modal.visible { opacity: 1; pointer-events: auto; }
        .options-modal .modal-content {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); color: #fff; padding: 2rem; border-radius: 20px;
            width: 90%; max-width: 500px; text-align: right; transform: translateY(-20px); transition: transform 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        .options-modal.visible .modal-content { transform: translateY(0); }
        
        /* تنسيقات النافذة المنبثقة للنتائج */
        .result-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 2000; 
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 300px;
            animation: popupShow 0.5s ease-out forwards;
        }
        @keyframes popupShow {
            0% { transform: translate(-50%, -50%) scale(0) rotate(180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }
        
        /* تنسيقات قصاصات الاحتفال (النسخة الجديدة المعتمدة على مكتبة) */
        .confetti-container {
            display: none; 
        }
        
        /* تنسيقات دائرة الرقم الكبيرة الجديدة */
        .large-number-circle {
            width: var(--number-circle-size);
            height: var(--number-circle-size);
            display: flex; align-items: center; justify-content: center; border-radius: 50%;
            background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 0 auto; transition: width 0.3s ease, height 0.3s ease;
        }
        .large-number-circle span {
            font-size: 8rem; font-weight: bold; color: white; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }

        /* تنسيقات منطقة عرض الاسم الفائز (مستطيل) */
        .large-name-display {
            max-width: var(--name-display-width);
            min-height: var(--name-display-height);
            margin: 0 auto; padding: 2rem; display: flex; flex-direction: column;
            align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-radius: 20px; text-align: center; transition: max-width 0.3s ease, min-height 0.3s ease;
            overflow-x: auto;
        }
        .large-name-display p { font-size: 1.5rem; font-weight: bold; color: white; margin-bottom: 0.5rem; }
        .large-name-display span {
            font-size: 2.5rem; font-weight: bold; color: white; max-width: 100%; padding: 0 1rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .large-name-display.wrap-text span { white-space: normal !important; overflow: visible; text-overflow: clip; }
        
        /* تنسيقات السحب والإفلات */
        .name-item.selected {
            background-color: #fff;
            color: #333;
            border-color: #4f46e5;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
            transform: scale(1.05);
        }
        .custom-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 2000; 
        }
        .custom-modal .modal-content {
            background: white; padding: 2rem; border-radius: 10px; max-width: 400px; width: 90%;
        }

        /* تنسيقات الفرق المخصصة */
        /* للعرض على الشاشات الكبيرة فقط */
        @media (min-width: 1024px) {
            .team-layout-2 {
                /* فريقان: مستطيلان كبيران فوق بعضهما */
                display: grid;
                grid-template-columns: 1fr;
                grid-template-rows: repeat(2, 1fr);
                grid-auto-flow: row;
            }
            .team-layout-3 {
                /* ثلاثة فرق: ثلاث مستطيلات بالطول بجانب بعضها */
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-auto-flow: column;
            }
            .team-layout-4 {
                /* أربعة فرق: 2x2 شبكة */
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 1rem; 
            }
            .team-layout-5 {
                /* خمسة فرق: 3 فوق و 2 تحت (باستخدام Flexbox للالتفاف) */
                display: flex;
                flex-wrap: wrap;
            }
            .team-layout-5 > div {
                flex: 1 1 30%; 
                min-width: 200px;
            }
            .team-layout-6 {
                /* ستة فرق: 3 فوق و 3 تحت */
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        /* لضمان التوافق مع Flexbox على الشاشات الصغيرة وتطبيق العرض الأفقي (Mobile) */
        @media (max-width: 1023px) {
             #teamsContainer > div {
                /* هذا يضمن بقاء العناصر أفقية على الجوال */
                min-width: 256px; 
                width: 256px;
                flex-shrink: 0;
            }
        }

    </style>
</head>
<body class="gradient-bg min-h-screen p-4 flex items-center justify-content-center">
    <div class="max-w-6xl mx-auto w-full">
        <!-- Main Menu Section -->
        <div id="main-menu" class="section">
            <div class="text-center mb-12">
                <h1 class="text-6xl font-bold mb-2 text-gradient"> صُدفة 6x</h1>
                <p class="text-white/80 text-2xl font-medium">أحمد الذبياني</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <a onclick="showSection('wheel')" class="glass-card card-hover rounded-2xl p-8 text-center cursor-pointer">
                    <img src="https://i.postimg.cc/d1GgydPZ/image.png" alt="عجلة الحظ" class="w-20 h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold">عجلة الحظ</h2>
                    <p class="text-white/80 mt-2">قم بتدوير العجلة لاختيار فائز</p>
                </a>
                
                <a onclick="showSection('numbers')" class="glass-card card-hover rounded-2xl p-8 text-center cursor-pointer">
                    <img src="https://i.postimg.cc/hPZZhMz3/image.png" alt="قرعة الأرقام" class="w-20 h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold">قرعة الأرقام</h2>
                    <p class="text-white/80 mt-2">اختر رقمًا عشوائيًا من 1 إلى ما تريد</p>
                </a>
                
                <a onclick="showSection('names')" class="glass-card card-hover rounded-2xl p-8 text-center cursor-pointer">
                    <img src="https://i.postimg.cc/RVPVP3qn/image.png" alt="قرعة الأسماء" class="w-20 h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold">قرعة الأسماء</h2>
                    <p class="text-white/80 mt-2">مخصص للعرض على شاشة</p>
                </a>
                
                <a onclick="showSection('dice')" class="glass-card card-hover rounded-2xl p-8 text-center cursor-pointer">
                    <img src="https://i.postimg.cc/3xdrzKDf/image.png" alt="النرد" class="w-20 h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold">النرد</h2>
                    <p class="text-white/80 mt-2">قرعة سريعة من 1 الى 24</p>
                </a>
                
                <a onclick="showSection('coin')" class="glass-card card-hover rounded-2xl p-8 text-center cursor-pointer">
                    <img src="https://i.postimg.cc/0jJ3CXQc/image.png" alt="قلب العملة" class="w-20 h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold">قلب العملة</h2>
                    <p class="text-white/80 mt-2">صورة أو كتابة</p>
                </a>
                
                <a onclick="showSection('drag-and-drop')" class="glass-card card-hover rounded-2xl p-8 text-center cursor-pointer">
                    <img src="https://i.postimg.cc/yx1sjBHP/image.png" alt="ترتيب الأسماء" class="w-20 h-20 mx-auto mb-4">
                    <h2 class="text-2xl font-bold">ترتيب الأسماء</h2>
                    <p class="text-white/80 mt-2">قم بفرز الأسماء في قوائم "أسهل طريقة للتقسيم"</p>
                </a>
            </div>
        </div>

        <!-- Wheel Section -->
        <div id="wheel-section" class="section hidden flex flex-col justify-center items-center h-screen">
             <!-- Return Button -->
            <a onclick="showSection('main-menu')" class="inline-flex items-center text-white/80 hover:text-white transition-colors absolute top-4 right-4 z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="mr-2">العودة</span>
            </a>
            
            <div class="flex flex-col items-center justify-center w-full h-full -mt-20">
                <div id="wheel-container" class="wheel-container fullscreen-wheel-container" style="--size: min(84vw, 84vh);"> 
                    <canvas id="wheelCanvas" class="wheel fullscreen-wheel" width="320" height="320"></canvas>
                     <!-- المؤشر الجديد (CSS Triangle) -->
                     <div id="wheelPointer" class="pin-pointer"></div>
                     <!-- النقطة الحمراء لتحديد الموقع الدقيق للفوز -->
                     <div class="winning-pin"></div>
                </div>
                <div class="text-center mt-8">
                    <button id="spinWheelButton" onclick="spinWheel()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all">
                        تدوير العجلة
                    </button>
                    <button onclick="toggleWheelOptionsModal()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all mr-4">
                        إدارة الخيارات
                    </button>
                </div>
            </div>

            <!-- Modal for Wheel Options -->
            <div id="wheelOptionsModal" class="options-modal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-2xl font-bold">إدارة خيارات عجلة الحظ</h3>
                        <button onclick="toggleWheelOptionsModal()" class="text-white/80 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex flex-col items-center gap-4 mb-4 text-white">
                         <!-- Slider for Wheel Size - تم إرجاع الشريط ليظهر على جميع الأجهزة -->
                        <div class="w-full flex items-center gap-2">
                            <label for="wheelSizeSlider" class="flex-1 text-sm">حجم العجلة (%):</label>
                            <input type="range" id="wheelSizeSlider" value="84" min="50" max="100" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveWheelSettings()">
                            <span id="wheelSizeValue" class="w-10 text-right">84</span>
                        </div>
                        <div class="w-full flex items-center gap-2">
                            <label for="spinDuration" class="flex-1 text-sm">مدة الدوران (ثانية):</label>
                            <input type="range" id="spinDuration" value="5" min="3" max="15" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveWheelSettings()">
                            <span id="durationValue" class="w-10 text-right">5</span>
                        </div>
                         <div class="w-full flex flex-col items-start justify-start gap-3">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showWheelPopup" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveWheelSettings()">
                                <label for="showWheelPopup" class="text-sm text-white">إظهار النافذة المنبثقة للنتيجة</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showWheelConfetti" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveWheelSettings()">
                                <label for="showWheelConfetti" class="text-sm text-white">إظهار الاحتفال (قصاصات)</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <textarea id="wheelOptionsTextarea" placeholder="أدخل خيارات جديدة (كل خيار في سطر)" class="flex-1 px-4 py-2 rounded-lg border-0 bg-white/50 text-gray-800"></textarea>
                    </div>
                    <button onclick="addWheelOption()" class="w-full bg-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/50">إضافة الأسماء</button>
                    <div id="wheelOptions" class="space-y-2 max-h-40 overflow-y-auto mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Numbers Section -->
        <div id="numbers-section" class="section hidden flex flex-col justify-center items-center h-screen">
             <!-- Return Button -->
            <a onclick="showSection('main-menu')" class="inline-flex items-center text-white/80 hover:text-white transition-colors absolute top-4 right-4 z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="mr-2">العودة</span>
            </a>

            <div class="flex flex-col items-center justify-center w-full h-full -mt-20">
                <div id="numberResult" class="text-center">
                    <div id="numberDisplayContainer" class="large-number-circle">
                        <span id="selectedNumber">؟</span>
                    </div>
                </div>
                
                <div class="text-center mt-12 flex gap-4">
                    <button id="generateNumberButton" onclick="generateRandomNumber()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all flex-1">
                        اختيار رقم عشوائي
                    </button>
                    <button onclick="toggleNumberOptionsModal()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all flex-shrink-0">
                        إدارة الخيارات
                    </button>
                </div>
            </div>
            
            <!-- Modal for Number Options -->
            <div id="numberOptionsModal" class="options-modal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-2xl font-bold">إدارة خيارات قرعة الأرقام</h3>
                        <button onclick="toggleNumberOptionsModal()" class="text-white/80 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="glass-card rounded-lg p-6 mb-6">
                        <!-- Slider for Number Size -->
                        <div class="w-full flex items-center gap-2 mb-4">
                            <label for="numberSizeSlider" class="flex-1 text-sm text-white">حجم الدائرة (%):</label>
                            <input type="range" id="numberSizeSlider" value="100" min="50" max="150" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveNumberSettings()">
                            <span id="numberSizeValue" class="w-10 text-right text-white">100</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-white mb-2">من:</label>
                                <input type="number" id="minNumber" value="1" class="w-full px-4 py-2 rounded-lg bg-white/50 text-gray-800" onchange="saveNumberSettings()">
                            </div>
                            <div>
                                <label class="block text-white mb-2">إلى:</label>
                                <input type="number" id="maxNumber" value="100" class="w-full px-4 py-2 rounded-lg bg-white/50 text-gray-800" onchange="saveNumberSettings()">
                            </div>
                        </div>
                        <div class="w-full flex items-center gap-2 mb-4 text-white">
                            <label for="numberDuration" class="flex-1 text-sm">مدة الدوران (ثانية):</label>
                            <input type="range" id="numberDuration" value="5" min="3" max="15" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveNumberSettings()">
                            <span id="numberDurationValue" class="w-10 text-right">5</span>
                        </div>
                        <div class="w-full flex flex-col items-start justify-start gap-3">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showNumberPopup" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveNumberSettings()">
                                <label for="showNumberPopup" class="text-sm text-white">إظهار النافذة المنبثقة للنتيجة</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showNumberConfetti" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveNumberSettings()">
                                <label for="showNumberConfetti" class="text-sm text-white">إظهار الاحتفال (قصاصات)</label>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleNumberOptionsModal()" class="w-full bg-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/50">حفظ الإعدادات</button>
                </div>
            </div>
        </div>

        <!-- Names Section -->
        <div id="names-section" class="section hidden flex flex-col justify-center items-center h-screen">
             <!-- Return Button -->
            <a onclick="showSection('main-menu')" class="inline-flex items-center text-white/80 hover:text-white transition-colors absolute top-4 right-4 z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="mr-2">العودة</span>
            </a>
            
            <div class="flex flex-col items-center justify-center w-full h-full -mt-20">
                <div id="nameResult" class="text-center overflow-x-auto w-full"> <!-- وسم w-full مهم هنا -->
                    <!-- Name Display Rectangle (Modified to large-name-display) -->
                    <div id="nameDisplayContainer" class="large-name-display">
                        <p class="text-white/90">الفائز:</p>
                        <span id="selectedName" class="text-white max-w-full">لم يتم الاختيار بعد</span>
                    </div>
                </div>
                
                <div class="text-center mt-12 flex gap-4">
                    <button id="selectNameButton" onclick="selectRandomName()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all flex-1">
                        اختيار اسم عشوائي
                    </button>
                    <button onclick="toggleNameOptionsModal()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all mr-4 flex-shrink-0">
                        إدارة الخيارات
                    </button>
                </div>
            </div>

            <!-- Modal for Name Options -->
            <div id="nameOptionsModal" class="options-modal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-2xl font-bold">إدارة خيارات قرعة الأسماء</h3>
                        <button onclick="toggleNameOptionsModal()" class="text-white/80 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex flex-col items-center gap-4 mb-4 text-white">
                        <!-- Slider for Name Width -->
                        <div class="w-full flex items-center gap-2">
                            <label for="nameWidthSlider" class="flex-1 text-sm">حجم العرض (W%):</label>
                            <input type="range" id="nameWidthSlider" value="100" min="50" max="200" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveNameSettings()">
                            <span id="nameWidthValue" class="w-10 text-right">100</span>
                        </div>
                        <!-- Slider for Name Height -->
                        <div class="w-full flex items-center gap-2">
                            <label for="nameHeightSlider" class="flex-1 text-sm">حجم الارتفاع (H%):</label>
                            <input type="range" id="nameHeightSlider" value="100" min="50" max="200" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveNameSettings()">
                            <span id="nameHeightValue" class="w-10 text-right">100</span>
                        </div>
                        <div class="w-full flex items-center gap-2">
                            <label for="nameDuration" class="flex-1 text-sm">مدة الدوران (ثانية):</label>
                            <input type="range" id="nameDuration" value="5" min="3" max="15" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveNameSettings()">
                            <span id="nameDurationValueModal" class="w-10 text-right">5</span>
                        </div>
                        <div class="w-full flex flex-col items-start justify-start gap-3">
                            <!-- الخيار الجديد لتقسيم السطر -->
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="wrapNameText" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveNameSettings()">
                                <label for="wrapNameText" class="text-sm text-white">السماح بتقسيم الاسم (عدة أسطر)</label>
                            </div>
                            <!-- الخيار الجديد: إقصاء الفائز تلقائياً -->
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="autoRemoveName" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveNameSettings()">
                                <label for="autoRemoveName" class="text-sm text-white">إقصاء الاسم الفائز تلقائياً</label>
                            </div>
                            <!-- خيارات النافذة المنبثقة -->
                             <div class="flex items-center gap-3">
                                <input type="checkbox" id="showNamePopup" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveNameSettings()">
                                <label for="showNamePopup" class="text-sm text-white">إظهار النافذة المنبثقة للنتيجة</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showNameConfetti" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveNameSettings()">
                                <label for="showNameConfetti" class="text-sm text-white">إظهار الاحتفال (قصاصات)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-lg p-6 mb-6">
                        <h3 class="text-white font-bold mb-4">قائمة الأسماء:</h3>
                        <div class="flex gap-2 mb-4">
                            <textarea id="namesTextarea" placeholder="أدخل أسماء جديدة (كل اسم في سطر)" class="flex-1 px-4 py-2 rounded-lg border-0 bg-white/50 text-gray-800"></textarea>
                        </div>
                        <button onclick="addNamesFromTextarea()" class="w-full bg-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/50">إضافة الأسماء</button>
                        <div id="namesList" class="space-y-2 max-h-40 overflow-y-auto mt-4"></div>
                        <button onclick="clearNames()" class="w-full mt-4 bg-white/30 text-white py-2 rounded-lg hover:bg-white/50">مسح الكل</button>
                    </div>
                    <button onclick="toggleNameOptionsModal()" class="w-full bg-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/50">إغلاق وحفظ</button>
                </div>
            </div>
        </div>

        <!-- Dice Section -->
        <div id="dice-section" class="section hidden">
            <!-- Return Button -->
            <a onclick="showSection('main-menu')" class="inline-flex items-center text-white/80 hover:text-white transition-colors mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="mr-2">العودة</span>
            </a>
            <div class="glass-card rounded-2xl p-8">
                <h1 class="text-3xl font-bold text-white mb-6 text-center">
                    <img src="https://i.postimg.cc/3xdrzKDf/image.png" alt="النرد" class="inline-block h-8 w-8 ml-2">
                    النرد
                </h1>
                <div class="max-w-md mx-auto text-center">
                    <div class="mb-6">
                        <label class="block text-white mb-2">عدد النرد:</label>
                        <select id="diceCount" class="px-4 py-2 rounded-lg bg-white/50 text-gray-800" onchange="handleDiceCountChange()">
                            <option value="1">نرد واحد</option>
                            <option value="2">نردان</option>
                            <option value="3">ثلاثة نرد</option>
                        </select>
                    </div>
                    <div class="dice-wrapper">
                        <div id="diceContainer" class="flex justify-center gap-4 mb-6"></div>
                    </div>
                    <div class="text-center mt-12 flex gap-4">
                        <button id="rollDiceButton" onclick="rollDice()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all flex-1">
                            رمي النرد
                        </button>
                        <button onclick="toggleDiceOptionsModal()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all mr-4 flex-shrink-0">
                            إدارة الخيارات
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal for Dice Options -->
            <div id="diceOptionsModal" class="options-modal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-2xl font-bold">إدارة خيارات النرد</h3>
                        <button onclick="toggleDiceOptionsModal()" class="text-white/80 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="glass-card rounded-lg p-6 mb-6">
                        <div class="w-full flex flex-col items-start justify-start gap-3">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showDicePopup" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveDiceSettings()">
                                <label for="showDicePopup" class="text-sm text-white">إظهار النافذة المنبثقة للنتيجة</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showDiceConfetti" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveDiceSettings()">
                                <label for="showDiceConfetti" class="text-sm text-white">إظهار الاحتفال (قصاصات)</label>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleDiceOptionsModal()" class="w-full bg-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/50">حفظ الإعدادات</button>
                </div>
            </div>
        </div>

        <!-- Coin Section -->
        <div id="coin-section" class="section hidden">
            <!-- Return Button -->
            <a onclick="showSection('main-menu')" class="inline-flex items-center text-white/80 hover:text-white transition-colors mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="mr-2">العودة</span>
            </a>
            <div class="glass-card rounded-2xl p-8 text-center">
                <h1 class="text-3xl font-bold text-white mb-6">
                    <img src="https://i.postimg.cc/0jJ3CXQc/image.png" alt="قلب العملة" class="inline-block h-8 w-8 ml-2">
                    قلب العملة
                </h1>
                <div class="max-w-md mx-auto">
                    <div class="mb-6 coin-container">
                        <div id="coin" class="coin mx-auto">
                            <div class="coin-face coin-front">
                                <img src="https://i.postimg.cc/0jJ3CXQc/image.png" alt="وجه الصورة">
                            </div>
                            <div class="coin-face coin-back">
                                <img src="https://i.postimg.cc/hhWYZ8Qg/image.png" alt="وجه الكتابة">
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-12 flex gap-4">
                        <button id="flipCoinButton" onclick="flipCoin()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all flex-1">
                            قلب العملة
                        </button>
                        <button onclick="toggleCoinOptionsModal()" class="bg-white/30 text-white px-8 py-3 rounded-lg font-bold hover:bg-white/50 transition-all mr-4 flex-shrink-0">
                            إدارة الخيارات
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal for Coin Options -->
            <div id="coinOptionsModal" class="options-modal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-2xl font-bold">إدارة خيارات قلب العملة</h3>
                        <button onclick="toggleCoinOptionsModal()" class="text-white/80 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="glass-card rounded-lg p-6 mb-6">
                        <div class="w-full flex items-center gap-2 mb-4 text-white">
                            <label for="coinDuration" class="flex-1 text-sm">مدة الدوران (ثانية):</label>
                            <input type="range" id="coinDuration" value="3" min="3" max="10" class="flex-1 h-2 bg-white/80 rounded-lg appearance-none cursor-pointer" onchange="saveCoinSettings()">
                            <span id="coinDurationValue" class="w-10 text-right">3</span>
                        </div>
                        <div class="w-full flex flex-col items-start justify-start gap-3">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showCoinPopup" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveCoinSettings()">
                                <label for="showCoinPopup" class="text-sm text-white">إظهار النافذة المنبثقة للنتيجة</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="showCoinConfetti" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="saveCoinSettings()">
                                <label for="showCoinConfetti" class="text-sm text-white">إظهار الاحتفال (قصاصات)</label>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleCoinOptionsModal()" class="w-full bg-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/50">حفظ الإعدادات</button>
                </div>
            </div>
        </div>
        
        <!-- Drag and Drop Section -->
        <div id="drag-and-drop-section" class="section hidden">
            <!-- Return Button -->
            <a onclick="showSection('main-menu')" class="inline-flex items-center text-white/80 hover:text-white transition-colors mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="mr-2">العودة</span>
            </a>
             <div class="glass-card rounded-2xl p-8">
                <h1 class="text-3xl font-bold text-white mb-6 text-center">
                    <img src="https://i.postimg.cc/yx1sjBHP/image.png" alt="ترتيب الأسماء" class="inline-block h-8 w-8 ml-2">
                    ترتيب الأسماء
                </h1>
                <div class="max-w-6xl mx-auto">
                    <!-- Team Selection Section -->
                    <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex gap-4 items-center justify-center flex-wrap">
                            <label class="text-lg font-semibold text-white">عدد الفرق:</label>
                            <select id="teamCount" class="px-4 py-2 rounded-lg focus:border-white focus:outline-none text-lg bg-white/20 text-gray-800" onchange="handleTeamCountChange()">
                                <option value="2">فريقان</option>
                                <option value="3">ثلاثة فرق</option>
                                <option value="4" selected>أربعة فرق</option>
                                <option value="5">خمسة فرق</option>
                                <option value="6">ستة فرق</option>
                            </select>
                        </div>
                    </div>

                    <!-- Add Name Section -->
                    <div class="glass-card rounded-xl shadow-lg p-6 mb-8">
                        <div class="space-y-4">
                            <div class="border-t border-white/30 pt-4">
                                <label class="block text-sm font-medium text-white mb-2">أضف عدة أسماء (اسم في كل سطر أو مفصولة بفواصل):</label>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <textarea
                                        id="multipleNamesInput"
                                        placeholder="عبدالحميد بن ابراهيم&#10;خالد فيصل"
                                        rows="4"
                                        class="flex-1 w-full px-4 py-3 border-2 border-white/30 rounded-lg focus:border-white focus:outline-none text-lg resize-none bg-white/20 text-gray-800 placeholder-white/70"
                                    ></textarea>
                                    <button
                                        id="addMultipleBtn"
                                        class="w-full sm:w-auto bg-white/30 hover:bg-white/50 text-white px-6 py-3 rounded-lg font-semibold transition-colors self-start"
                                    >
                                        ➕ إضافة الكل
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lists Container -->
                    <div class="flex flex-col lg:flex-row gap-4">
                        <!-- Unorganized Names -->
                        <div class="lg:w-64 w-full flex-shrink-0">
                            <div class="glass-card rounded-xl shadow-lg p-4 h-full">
                                <div class="flex justify-between items-center mb-4 flex-wrap">
                                    <h2 class="text-lg font-bold text-white flex items-center">
                                        📝 الأسماء غير المرتبة
                                    </h2>
                                    <div class="flex gap-2">
                                        <button
                                            id="randomDistributeBtn"
                                            class="bg-white/30 hover:bg-white/50 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            🎲 توزيع عشوائي
                                        </button>
                                        <button
                                            id="clearAllBtn"
                                            class="bg-white/30 hover:bg-white/50 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            🗑️ مسح الكل
                                        </button>
                                        <button
                                            id="resetAllBtn"
                                            class="bg-white/30 hover:bg-white/50 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            🔄 إعادة ضبط
                                        </button>
                                    </div>
                                </div>
                                <div
                                    id="unorganized"
                                    class="h-48 lg:h-96 p-3 border-2 border-dashed border-white/30 rounded-lg bg-white/10 overflow-y-auto"
                                >
                                    <!-- Names will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Teams Container (Optimized for Mobile Horizontal Scroll) -->
                        <div id="teamsContainer" class="flex-1 flex flex-nowrap lg:flex-wrap overflow-x-auto gap-4 py-4">
                            <!-- Teams will be generated here -->
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="mt-8 glass-card rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-white mb-4">📊 الإحصائيات</h3>
                        <div id="statisticsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Statistics will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // المتغيرات العامة لتخزين خيارات الرول والأسماء
        let wheelOptions = ['الخيار 1', 'الخيار 2', 'الخيار 3', 'الخيار 4'];
        let names = []; // قائمة أسماء قرعة الأسماء
        let currentSection = 'main-menu'; // لتتبع القسم الحالي لسجل المتصفح
        
        let isSpinning = false;
        
        let nameCounter = 0; // لضمان معرف فريد لكل اسم في السحب والإفلات
        let currentTeamCount = 4;
        let selectedNameId = null;
        
        // متغيرات عجلة الحظ للسحب
        let isDragging = false;
        let lastAngle = 0;
        let currentRotation = 0;
        let lastTime = 0;
        let velocity = 0;

        // **الألوان المصححة للفرق:** (أحمر، أزرق، أخضر، أصفر، بنفسجي، برتقالي)
        const teamConfigs = [
            { id: 1, name: 'الفريق الأحمر', color: 'red', emoji: '🔴', bgClass: 'team-red' },
            { id: 2, name: 'الفريق الأزرق', color: 'blue', emoji: '🔵', bgClass: 'team-blue' },
            { id: 3, name: 'الفريق الأخضر', color: 'green', emoji: '🟢', bgClass: 'team-green' },
            { id: 4, name: 'الفريق الأصفر', color: 'yellow', emoji: '🟡', bgClass: 'team-yellow' },
            { id: 5, name: 'الفريق البنفسجي', color: 'purple', emoji: '🟣', bgClass: 'team-purple' },
            { id: 6, name: 'الفريق البرتقالي', color: 'orange', emoji: '🟠', bgClass: 'team-orange' }
        ];

        // ** قائمة أسماء الفرق القابلة للتخصيص **
        let customTeamNames = {};
        
        // ==========================================================
        //         دوّال الصوت (استخدام أصوات واقعية من ملفات)
        // ==========================================================
        
        const sounds = {
            // صوت تكتكة / دوران (من GitHub)
            spin: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA-%D8%A7%D9%84%D8%B9%D8%AC%D9%84%D8%A9.mp3"),
            // صوت الفوز (تم إلغاؤه - سيتم استخدام Cheer بدلاً منه)
            win: new Audio(""), 
            // صوت النقر / التيك السريع (يستخدم لعد الأسماء - نرد.m4a)
            // ** تم تغيير click لاستخدام صوت number لضمان صوت عد مستمر **
            click: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA%20%D8%A7%D9%84%D8%A7%D8%B1%D9%82%D8%A7%D9%852%20.mp3"),
            // صوت عد الأرقام (الرابط الجديد)
            number: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA%20%D8%A7%D9%84%D8%A7%D8%B1%D9%82%D8%A7%D9%852%20.mp3"),
            // صوت احتفال الجمهور (الرابط الجديد) - يستخدم كصوت فوز بصري
            cheer: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA%20%D9%81%D9%88%D8%B2.mp3.mp3"),
            // صوت قلب العملة (الرابط الجديد)
            coin: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA%20%D8%B9%D9%85%D9%84%D8%A9.mp3"),
            // صوت رمي النرد (الرابط الجديد)
            dice: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D9%86%D8%B1%D8%AF%D9%8A%203.m4a"), 
            // صوت أخذ الأسماء من القائمة (الرابط الجديد)
            take_name: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA%20%D8%A7%D8%AE%D8%B0.mp3"),
            // صوت وضع الأسماء في القائمة (الرابط الجديد)
            put_name: new Audio("https://github.com/Abo3bdallah/my-saond/raw/refs/heads/main/%D8%B5%D9%88%D8%AA%20%D9%88%D8%B6%D8%B9.mp3"),
            // صوت خطأ/تنبيه (Pixabay)
            error: new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_249df9c4d9.mp3")
        };
        
        // ** تفعيل التكرار لأصوات الدوران والعملة والأرقام **
        sounds.spin.loop = true; 
        sounds.coin.loop = true; 
        sounds.number.loop = true;
        // ** تفعيل التكرار لصوت العد في قرعة الأسماء (click) **
        sounds.click.loop = true;

        // دالة مساعدة لتشغيل أي صوت بسرعة وإعادة ضبطه
        function playSound(type) {
             const sound = sounds[type];
             if (sound && sound.src.length > 0) { 
                 // ** إيقاف الأصوات التي تتكرر قبل تشغيل صوت آخر **
                 const isLoopingSound = (type === 'spin' || type === 'coin' || type === 'number' || type === 'click');
                 
                 if (isLoopingSound) {
                    sound.currentTime = 0;
                 }
                 
                 // إيقاف أصوات الدوران والتكتكة عند تشغيل أصوات أخرى
                 if (type === 'error' || type === 'cheer' || type === 'take_name' || type === 'put_name' || type === 'dice') {
                     sounds.spin.pause();
                     sounds.coin.pause();
                     sounds.number.pause();
                     sounds.click.pause();
                 }
                 
                 sound.play().catch(e => console.error("Error playing sound:", type, e)); 
             }
        }
        
        // ** دوال الإيقاف الخاصة **
        function stopSpinSound() {
            sounds.spin.pause();
            sounds.spin.currentTime = 0;
        }

        function stopCoinSound() {
            sounds.coin.pause();
            sounds.coin.currentTime = 0;
        }

        function stopNumberSound() {
            sounds.number.pause();
            sounds.number.currentTime = 0;
        }
        
        // ** دالة إيقاف صوت عد الأسماء **
        function stopNameTickSound() {
            sounds.click.pause();
            sounds.click.currentTime = 0;
        }

        function stopCheerSound() {
            sounds.cheer.pause();
            sounds.cheer.currentTime = 0;
        }

        
        // ==========================================================
        //         دوّال الحفظ والتحميل (localStorage)
        // ==========================================================
        
        // دالة لحفظ أي قيمة في localStorage
        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("Error saving to localStorage", e);
            }
        }

        // دالة لتحميل أي قيمة من localStorage
        function loadFromLocalStorage(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error("Error loading from localStorage", e);
                return defaultValue;
            }
        }
        
        // ----------------- حفظ إعدادات عجلة الحظ -----------------
        function saveWheelSettings() {
            // حفظ الخيارات والقائمة
            saveToLocalStorage('wheelOptions', wheelOptions);
            
            // حفظ الإعدادات الأخرى
            const settings = {
                size: document.getElementById('wheelSizeSlider').value,
                duration: document.getElementById('spinDuration').value,
                // ** تم حذف speed **
                showPopup: document.getElementById('showWheelPopup').checked,
                showConfetti: document.getElementById('showWheelConfetti').checked,
            };
            saveToLocalStorage('wheelSettings', settings);
        }
        
        // دالة لتحميل وتطبيق إعدادات عجلة الحظ
        function loadWheelSettings() {
            wheelOptions = loadFromLocalStorage('wheelOptions', ['الخيار 1', 'الخيار 2', 'الخيار 3', 'الخيار 4']);
            // ** تم حذف speed من الإعدادات الافتراضية **
            const settings = loadFromLocalStorage('wheelSettings', {
                size: 84, duration: 5, showPopup: true, showConfetti: true 
            });
            
            // تطبيق القيم على عناصر التحكم
            document.getElementById('wheelSizeSlider').value = settings.size;
            document.getElementById('durationValue').textContent = settings.duration;
            document.getElementById('spinDuration').value = settings.duration;
            // ** تم حذف تطبيق قيمة السرعة **
            document.getElementById('showWheelPopup').checked = settings.showPopup;
            document.getElementById('showWheelConfetti').checked = settings.showConfetti;
        }
        
        // ----------------- حفظ إعدادات قرعة الأرقام -----------------
        function saveNumberSettings() {
            const settings = {
                size: document.getElementById('numberSizeSlider').value,
                min: document.getElementById('minNumber').value,
                max: document.getElementById('maxNumber').value,
                duration: document.getElementById('numberDuration').value,
                showPopup: document.getElementById('showNumberPopup').checked,
                showConfetti: document.getElementById('showNumberConfetti').checked,
            };
            saveToLocalStorage('numberSettings', settings);
        }

        // دالة لتحميل وتطبيق إعدادات قرعة الأرقام
        function loadNumberSettings() {
            const settings = loadFromLocalStorage('numberSettings', {
                size: 100, min: 1, max: 100, duration: 5, showPopup: true, showConfetti: true 
            });
            
            // تطبيق القيم على عناصر التحكم
            document.getElementById('numberSizeSlider').value = settings.size;
            document.getElementById('numberSizeValue').textContent = settings.size;
            document.getElementById('minNumber').value = settings.min;
            document.getElementById('maxNumber').value = settings.max;
            document.getElementById('numberDuration').value = settings.duration;
            document.getElementById('numberDurationValue').textContent = settings.duration;
            document.getElementById('showNumberPopup').checked = settings.showPopup;
            document.getElementById('showNumberConfetti').checked = settings.showConfetti;
        }

        // ----------------- حفظ إعدادات قرعة الأسماء -----------------
        function saveNameSettings() {
            // حفظ القائمة
            saveToLocalStorage('namesList', names);
            
            // حفظ الإعدادات الأخرى
            const settings = {
                width: document.getElementById('nameWidthSlider').value,
                height: document.getElementById('nameHeightSlider').value,
                duration: document.getElementById('nameDuration').value,
                wrapText: document.getElementById('wrapNameText').checked,
                autoRemoveName: document.getElementById('autoRemoveName').checked, // حفظ الخيار الجديد
                showPopup: document.getElementById('showNamePopup').checked,
                showConfetti: document.getElementById('showNameConfetti').checked,
            };
            saveToLocalStorage('nameSettings', settings);
        }

        // دالة لتحميل وتطبيق إعدادات قرعة الأسماء
        function loadNameSettings() {
            names = loadFromLocalStorage('namesList', []); // يتم تحميل القائمة
            const settings = loadFromLocalStorage('nameSettings', {
                width: 100, height: 100, duration: 5, wrapText: false, autoRemoveName: false, showPopup: true, showConfetti: true
            });
            
            // تطبيق القيم على عناصر التحكم
            document.getElementById('nameWidthSlider').value = settings.width;
            document.getElementById('nameHeightSlider').value = settings.height;
            document.getElementById('nameDuration').value = settings.duration;
            document.getElementById('nameDurationValueModal').textContent = settings.duration;
            document.getElementById('wrapNameText').checked = settings.wrapText;
            document.getElementById('autoRemoveName').checked = settings.autoRemoveName; // تحميل الخيار الجديد
            document.getElementById('showNamePopup').checked = settings.showPopup;
            document.getElementById('showNameConfetti').checked = settings.confetti;
            
            // إذا كانت قائمة الأسماء فارغة عند التحميل، أضف أسماء عينة لتكون جاهزة للاستخدام
            if (names.length === 0) {
                 names = ['عبدالحميد بن ابراهيم', 'خالد فيصل', 'محمد علي', 'سالم عبدالله'];
                 saveNameSettings(); // حفظ قائمة العينة
            }
        }
        
        // ----------------- حفظ إعدادات النرد والعملة -----------------
        
        // ** دوال حفظ وتحميل إعدادات النرد الجديدة **
        function saveDiceSettings() {
            const settings = {
                count: document.getElementById('diceCount').value,
                showPopup: document.getElementById('showDicePopup').checked,
                showConfetti: document.getElementById('showDiceConfetti').checked
            };
            saveToLocalStorage('diceSettings', settings);
        }
        
        function loadDiceSettings() {
            const settings = loadFromLocalStorage('diceSettings', {
                count: 2, showPopup: false, showConfetti: false // الافتراضي: عدم تفعيل
            });
            document.getElementById('diceCount').value = settings.count;
            
            // تحميل حالة النوافذ المنبثقة
            const showPopupCheckbox = document.getElementById('showDicePopup');
            const showConfettiCheckbox = document.getElementById('showDiceConfetti');

            if (showPopupCheckbox) showPopupCheckbox.checked = settings.showPopup;
            if (showConfettiCheckbox) showConfettiCheckbox.checked = settings.showConfetti;
        }

        // ** دالة حفظ إعدادات العملة الجديدة **
        function saveCoinSettings() {
            const settings = {
                duration: document.getElementById('coinDuration').value,
                showPopup: document.getElementById('showCoinPopup').checked,
                showConfetti: document.getElementById('showCoinConfetti').checked,
            };
            saveToLocalStorage('coinSettings', settings);
        }

        // ** دالة تحميل إعدادات العملة الجديدة **
        function loadCoinSettings() {
             const settings = loadFromLocalStorage('coinSettings', {
                duration: 3, showPopup: false, showConfetti: false // الافتراضي: عدم تفعيل النافذة المنبثقة والقصاصات
            });

            document.getElementById('coinDuration').value = settings.duration;
            document.getElementById('coinDurationValue').textContent = settings.duration;
            document.getElementById('showCoinPopup').checked = settings.showPopup;
            document.getElementById('showCoinConfetti').checked = settings.showConfetti;
        }
        
        // ----------------- حفظ إعدادات السحب والإفلات (الفرق) -----------------
        
        // دالة لالتقاط حالة الأسماء في جميع الصناديق وحفظها
        function saveDragAndDropState() {
            const state = {};
            state.teamCount = document.getElementById('teamCount').value;
            state.names = {};
            
            // ** حفظ أسماء الفرق المخصصة **
            state.customTeamNames = customTeamNames; 
            
            const allContainers = document.querySelectorAll('#unorganized, [id^="team"]');
            allContainers.forEach(container => {
                const containerId = container.id;
                state.names[containerId] = [];
                Array.from(container.children).forEach(nameItem => {
                    const name = nameItem.querySelector('span')?.textContent || nameItem.textContent.trim();
                    const id = nameItem.id; // حفظ المعرف لتتبع الاسم
                    if (name && id) {
                        state.names[containerId].push({ id, name });
                    }
                });
            });
            
            // حفظ أكبر عداد لضمان عدم تكرار المعرفات
            state.nameCounter = nameCounter; 
            
            saveToLocalStorage('dragAndDropState', state);
        }
        
        // دالة لتحميل وتطبيق حالة الفرق
        function loadDragAndDropState() {
            const defaultState = {
                teamCount: 4,
                names: {
                    unorganized: [{ id: 'name-1', name: 'عبدالحميد بن ابراهيم' }, { id: 'name-2', name: 'خالد فيصل' }],
                    team1: [], team2: [], team3: [], team4: []
                },
                nameCounter: 2,
                customTeamNames: {}
            };
            
            const state = loadFromLocalStorage('dragAndDropState', defaultState);
            
            // 1. تطبيق عدد الفرق
            currentTeamCount = parseInt(state.teamCount);
            const teamCountSelect = document.getElementById('teamCount');
            if (teamCountSelect.querySelector(`option[value="${currentTeamCount}"]`)) {
                teamCountSelect.value = currentTeamCount;
            } else {
                 currentTeamCount = 4; // تعيين قيمة افتراضية في حالة الخطأ
                 teamCountSelect.value = 4;
            }
            
            // 2. تحديث عداد الأسماء
            nameCounter = state.nameCounter || 0;
            
            // ** 3. تحميل أسماء الفرق المخصصة **
            customTeamNames = state.customTeamNames || {};

            // 4. إعادة توليد الفرق ثم ملء الأسماء
            generateTeams(); // هذا سيقوم بمسح الأسماء القديمة من الحاويات

            // ملء الأسماء في الحاويات الجديدة
            Object.keys(state.names).forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    state.names[containerId].forEach(nameObj => {
                        const nameElement = createNameElement(nameObj.name, nameObj.id.split('-')[1]); // إعادة استخدام المعرف
                        nameElement.id = nameObj.id; // التأكد من أن المعرف هو نفسه
                        container.appendChild(nameElement);
                    });
                }
            });
            
            updateStatistics();
        }
        
        
        // --- دوال التنقل والتهيئة ودعم زر الرجوع ---
        
        // دالة عامة لإظهار الأقسام وإخفائها
        function showSection(sectionName, pushState = true) {
            // تحديث القسم الحالي
            currentSection = sectionName;

            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            const sectionId = sectionName === 'main-menu' ? 'main-menu' : sectionName + '-section';
            const sectionElement = document.getElementById(sectionId);
            
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
                
                // 1. إدارة سجل المتصفح (History API)
                if (pushState) {
                    // نحتاج فقط لتغيير حالة السجل، ليس شرطًا تغيير الـ URL فعليًا
                    history.pushState({ section: sectionName }, '', `#${sectionName}`);
                }
                
                // تهيئة الأقسام عند الانتقال إليها
                if (sectionName === 'wheel') {
                    // يجب تحميل الإعدادات أولاً
                    loadWheelSettings();
                    
                    const canvas = document.getElementById('wheelCanvas');
                    const container = document.getElementById('wheel-container');
                    
                    // استخدام القيمة المحفوظة في شريط التحكم
                    const sizeValue = document.getElementById('wheelSizeSlider').value;
                    // ** تم تطبيق الحجم المحفوظ هنا **
                    container.style.width = `min(${sizeValue}vw, ${sizeValue}vh)`;
                    container.style.height = `min(${sizeValue}vw, ${sizeValue}vh)`;
                    
                    // 1. دعم الشاشات عالية الدقة (HiDPI)
                    const ratio = window.devicePixelRatio || 1;
                    canvas.width = container.offsetWidth * ratio;
                    canvas.height = container.offsetHeight * ratio;
                    canvas.getContext('2d').scale(ratio, ratio);
                    
                    // تحديث شريط التمرير ليعكس القيمة الافتراضية الجديدة
                    document.getElementById('wheelSizeValue').textContent = sizeValue;

                    updateWheel();
                    // تهيئة مستمع لتحديث العجلة عند تغيير حجم النافذة
                    window.onresize = () => {
                        const canvas = document.getElementById('wheelCanvas');
                        const container = document.getElementById('wheel-container');
                        
                        // إعادة ضبط Canvas للحجم الجديد
                        const resizeRatio = window.devicePixelRatio || 1;
                        canvas.width = container.offsetWidth * resizeRatio;
                        canvas.height = container.offsetHeight * resizeRatio;
                        canvas.getContext('2d').scale(resizeRatio, resizeRatio);
                        
                        updateWheel();
                    };
                    setupWheelDrag(); // تفعيل سحب العجلة
                } else if (sectionName === 'dice') {
                    loadDiceSettings(); // تحميل إعدادات النرد
                    updateDiceContainer();
                } else if (sectionName === 'names') {
                    loadNameSettings(); // تحميل إعدادات وقائمة الأسماء
                    updateNamesList();
                    updateNameDisplaySize(false);
                } else if (sectionName === 'numbers') {
                    loadNumberSettings(); // تحميل إعدادات الأرقام
                    updateNumberCircleSize(false);
                } else if (sectionName === 'coin') {
                    loadCoinSettings(); // تحميل إعدادات العملة
                } else if (sectionName === 'drag-and-drop') {
                    // ** تم تعديل Init ليستخدم دالة Load **
                    loadDragAndDropState();
                    setupDragAndDropEventListeners();
                } else {
                    window.onresize = null; // إزالة مستمع تغيير الحجم عندما لا نكون في العجلة
                    removeWheelDrag(); // تعطيل سحب العجلة
                }
            }
        }
        
        // 2. مستمع لحدث زر الرجوع في المتصفح/الجوال
        window.addEventListener('popstate', function(event) {
            // التحقق من وجود حالة محفوظة
            if (event.state && event.state.section) {
                // عرض القسم المحفوظ في الحالة دون إضافة إدخال جديد للسجل
                showSection(event.state.section, false); 
            } else {
                // إذا لم تكن هناك حالة، افترض العودة إلى القائمة الرئيسية (أو إغلاق التطبيق إذا كان هذا هو الإدخال الأول)
                // نظرًا لأننا ندفع دائمًا 'main-menu' كحالة أولية، فإن هذا عادةً لن يتم تشغيله إلا إذا كان التطبيق في الحالة الأساسية.
                showSection('main-menu', false); 
            }
        });


        // ** دالة فتح وإغلاق إعدادات النرد الجديدة **
        function toggleDiceOptionsModal() {
            document.getElementById('diceOptionsModal').classList.toggle('visible');
        }
        
        // دالة لتغيير عدد النرد مع حفظ الإعدادات
        function handleDiceCountChange() {
            updateDiceContainer();
            saveDiceSettings();
        }

        // ** دالة فتح وإغلاق إعدادات العملة الجديدة **
        function toggleCoinOptionsModal() {
            document.getElementById('coinOptionsModal').classList.toggle('visible');
        }

        
        // دوال فتح وإغلاق النوافذ المنبثقة
        function toggleWheelOptionsModal() {
            document.getElementById('wheelOptionsModal').classList.toggle('visible');
        }
        
        function toggleNumberOptionsModal() {
            document.getElementById('numberOptionsModal').classList.toggle('visible');
        }

        function toggleNameOptionsModal() {
            document.getElementById('nameOptionsModal').classList.toggle('visible');
        }

        // --- دوال قسم عجلة الحظ ---

        // دالة لتهيئة وظيفة السحب
        function setupWheelDrag() {
            const wheel = document.getElementById('wheelCanvas');
            wheel.addEventListener('mousedown', startDrag);
            wheel.addEventListener('touchstart', startDrag, { passive: true });
        }

        // دالة لتعطيل وظيفة السحب
        function removeWheelDrag() {
            const wheel = document.getElementById('wheelCanvas');
            wheel.removeEventListener('mousedown', startDrag);
            wheel.removeEventListener('touchstart', startDrag);
            // إزالة المستمعات من النافذة لضمان عدم حدوث مشاكل
            window.removeEventListener('mousemove', onDrag);
            window.removeEventListener('mouseup', endDrag);
            window.removeEventListener('touchmove', onDrag);
            window.removeEventListener('touchend', endDrag);
        }

        // حساب الزاوية من إحداثيات الماوس/اللمس
        function getAngle(x, y) {
            const rect = document.getElementById('wheelCanvas').getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
        }

        // بدء السحب
        function startDrag(event) {
            if (isSpinning) return;
            isDragging = true;
            document.getElementById('spinWheelButton').disabled = true; // تعطيل الزر أثناء السحب

            const clientX = event.clientX || event.touches[0].clientX;
            const clientY = event.clientY || event.touches[0].clientY;

            lastAngle = getAngle(clientX, clientY);
            lastTime = Date.now();
            velocity = 0;

            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchmove', onDrag);
            window.addEventListener('touchend', endDrag);
        }

        // أثناء السحب
        function onDrag(event) {
            if (!isDragging || isSpinning) return;
            
            const clientX = event.clientX || event.touches[0].clientX;
            const clientY = event.clientY || event.touches[0].clientY;
            
            const currentAngle = getAngle(clientX, clientY);
            let deltaAngle = currentAngle - lastAngle;

            // معالجة الانتقال من 360 إلى 0 أو العكس (لضمان تدوير سلس)
            if (deltaAngle > 180) {
                deltaAngle -= 360;
            } else if (deltaAngle < -180) {
                deltaAngle += 360;
            }

            const currentTime = Date.now();
            const deltaTime = currentTime - lastTime;
            
            currentRotation += deltaAngle;
            
            // تحديث دوران العجلة في الوقت الحقيقي
            const wheel = document.getElementById('wheelCanvas');
            wheel.style.transition = 'none';
            wheel.style.transform = `rotate(${currentRotation}deg)`;

            // حساب السرعة للحركة النهائية
            if (deltaTime > 0) {
                velocity = deltaAngle / deltaTime;
            }
            
            lastAngle = currentAngle;
            lastTime = currentTime;
        }

        // نهاية السحب
        function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            
            window.removeEventListener('mousemove', onDrag);
            window.removeEventListener('mouseup', endDrag);
            window.removeEventListener('touchmove', onDrag);
            window.removeEventListener('touchend', endDrag);
            
            // تحديد ما إذا كانت الحركة سريعة بما يكفي لتدوير العجلة
            const flickThreshold = 0.3; // عتبة السرعة (بالدرجات/ميلي ثانية)

            if (Math.abs(velocity) > flickThreshold) {
                // تدوير العجلة بناءً على السرعة النهائية
                spinWheel(true, velocity);
            } else {
                // العودة إلى وضع الاستعداد
                document.getElementById('spinWheelButton').disabled = false;
            }
        }


        // دالة لتحديث رسم العجلة بناءً على الخيارات المتاحة
        function updateWheel() {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            
            // 2. استخدام نسبة الأبعاد لتحديد المركز ونصف القطر بعد تطبيق scale
            const ratio = window.devicePixelRatio || 1;
            const centerX = canvas.width / (2 * ratio);
            const centerY = canvas.height / (2 * ratio);
            const radius = Math.min(centerX, centerY);

            const sections = wheelOptions.length;
            
            if (sections === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            const anglePerSection = (2 * Math.PI) / sections;
            // ألوان جديدة بتباين عالٍ وأكثر أناقة (لتصحيح مشكلة الوضوح)
            const glassColors = [
                'rgba(255, 69, 0, 0.5)',    // برتقالي ساطع (Red-Orange)
                'rgba(0, 206, 209, 0.5)',  // فيروزي (Turquoise)
                'rgba(255, 223, 0, 0.5)',  // أصفر ذهبي ساطع (Gold)
                'rgba(138, 43, 226, 0.5)', // بنفسجي
                'rgba(255, 99, 71, 0.5)',  // أحمر مرجاني
                'rgba(60, 179, 113, 0.5)',  // أخضر ميديوم
                'rgba(255, 140, 0, 0.4)',   // برتقالي داكن
                'rgba(0, 191, 255, 0.4)'    // أزرق سماوي
            ];
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            wheelOptions.forEach((option, index) => {
                // ** ملاحظة هامة: يجب أن يبدأ المقطع الأول (index 0) عند زاوية 270 درجة ليعمل الحساب **
                //  نبدأ الرسم من زاوية 270 درجة ($\frac{3\pi}{2}$) ونمشي في اتجاه عقارب الساعة (زيادة الزاوية)
                //  الرسم الحالي يبدأ من 270 درجة ويزيد، مما يجعل المقطع الأول يغطي الزاوية العلوية
                const startAngle = (index * anglePerSection) - (Math.PI / 2); // يبدأ من الساعة 12 (زاوية 270)
                const endAngle = ((index + 1) * anglePerSection) - (Math.PI / 2);
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                
                ctx.fillStyle = glassColors[index % glassColors.length];
                ctx.fill();
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)'; // إطار زجاجي ناعم
                ctx.lineWidth = 4; // سمك الإطار
                ctx.stroke();

                // رسم النص
                ctx.save();
                ctx.translate(centerX, centerY);
                const textAngle = startAngle + anglePerSection / 2;
                ctx.rotate(textAngle);
                
                ctx.fillStyle = 'white'; // لون نص أبيض واضح
                ctx.font = 'bold 20px Cairo'; // خط أكبر وأكثر جرأة
                
                /* --- التعديل: تمركز النص وإضافة الظل --- */
                ctx.textAlign = 'center'; // تمركز الخط في المنتصف
                ctx.textBaseline = 'middle';
                
                ctx.shadowColor = 'rgba(0, 0, 0, 0.9)'; // ظل قوي جداً
                ctx.shadowBlur = 4; // قوة الظل
                /* ------------------------------------- */

                
                let displayText = option;
                // تعديل: تحديد مركز النص في المنتصف (نصف المسافة إلى الحافة)
                const textPosition = Math.round(radius * 0.65); 
                const maxTextWidth = radius * 0.8;
                
                // قياس النص وضبطه (إضافة .. إذا كان طويلاً جداً)
                if (ctx.measureText(displayText).width > maxTextWidth) {
                    let tempText = '';
                    for (let i = 0; i < option.length; i++) {
                        if (ctx.measureText(tempText + option[i] + '..').width < maxTextWidth) {
                            tempText += option[i];
                        } else {
                            break;
                        }
                    }
                    displayText = tempText + '..';
                }

                // 3. تثبيت الإحداثيات بـ Math.round لمنع الغباشة
                const x = Math.round(textPosition);
                const y = Math.round(0);

                ctx.fillText(displayText, x, y);
                
                ctx.restore();
            });
            
            updateWheelOptionsList();
            
            // تحديث موضع المؤشر الثابت (يستخدم الإحداثيات العادية: offsetWidth)
            const pointer = document.getElementById('wheelPointer');
            const container = document.getElementById('wheel-container');
            if (pointer && container) {
                // *** إصلاح موضع المؤشر ليكون في منتصف الأعلى تماماً ***
                const pointerSize = 20; // حجم المؤشر (border-top)
                
                // left: 50% - 10px (Center of container - half pointer width)
                pointer.style.left = `calc(50% - 10px)`; 
                
                // top: 0 (At the top edge)
                pointer.style.top = `0`; 
            }
        }

        // دالة لتحديث قائمة الخيارات المعروضة
        function updateWheelOptionsList() {
            const container = document.getElementById('wheelOptions');
            if (!container) return;
            container.innerHTML = '';
            wheelOptions.forEach((option, index) => {
                const div = document.createElement('div');
                // تم تعديل لون النص إلى داكن لزيادة الوضوح في قائمة الإعدادات
                div.className = 'flex justify-between items-center bg-white/50 rounded px-3 py-2'; 
                div.innerHTML = `<span class="text-gray-900">${option}</span>
                                <button onclick="removeWheelOption(${index})" class="text-red-600 hover:text-red-800">✕</button>`;
                container.appendChild(div);
            });
        }

        // دالة لإضافة خيار جديد للعجلة
        function addWheelOption() {
            const textarea = document.getElementById('wheelOptionsTextarea');
            const newNames = textarea.value.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            if (newNames.length > 0) {
                // فحص التكرار قبل الإضافة
                const uniqueNewNames = newNames.filter(name => !wheelOptions.includes(name));
                if (uniqueNewNames.length > 0) {
                    wheelOptions = wheelOptions.concat(uniqueNewNames);
                    textarea.value = '';
                    updateWheel();
                    saveWheelSettings(); // ** الحفظ بعد التحديث **
                } else {
                     playSound('error');
                     showConfettiPopup('تنبيه', 'جميع الأسماء المدخلة موجودة بالفعل في العجلة.', null, null, false, true);
                }
            }
        }

        // دالة لإزالة خيار من العجلة
        function removeWheelOption(index) {
            if (wheelOptions.length > 2) {
                wheelOptions.splice(index, 1);
                updateWheel();
                saveWheelSettings(); // ** الحفظ بعد التحديث **
            } else {
                 playSound('error');
                 showConfettiPopup('خطأ', 'يجب أن يكون هناك خياران على الأقل في العجلة.', null, null, false, true);
            }
        }

        // دالة لتدوير العجلة (تم تعديلها لتقبل سرعة السحب)
        function spinWheel(isFlick = false, flickVelocity = 0) {
            if (isSpinning) return;
            if (wheelOptions.length < 2) {
                 playSound('error');
                 showConfettiPopup('خطأ', 'الرجاء إضافة خيارين على الأقل في العجلة.', null, null, false, true);
                 return;
            }
            
            isSpinning = true;
            document.getElementById('spinWheelButton').disabled = true;
            
            // ** قيمة السرعة الثابتة والمضبوطة (تم حذف شريط التمرير) **
            const spinSpeed = 7;
            
            const wheel = document.getElementById('wheelCanvas');
            wheel.removeEventListener('transitionend', handleSpinEnd);
            
            // تفعيل حركة الاهتزاز للمؤشر
            document.getElementById('wheelPointer').classList.add('wobble');

            // تشغيل صوت التدوير (Spin Sound)
            playSound('spin');

            // الحصول على الدوران الحالي لتبدأ منه الحركة
            const style = window.getComputedStyle(wheel);
            const matrix = new DOMMatrix(style.transform);
            
            // يجب أن نستخدم العنصر m21 أو m11 للحصول على الدوران الحالي (cos(theta) / sin(theta))
            const rotationRad = Math.atan2(matrix.b, matrix.a);
            currentRotation = rotationRad * (180 / Math.PI); // تحويل إلى درجات
            if (currentRotation < 0) currentRotation += 360;
            
            const spinDuration = parseInt(document.getElementById('spinDuration').value) * 1000;

            let totalDegrees;

            if (isFlick) {
                // حساب الدوران بناءً على سرعة السحب (Flick)
                const finalSpin = Math.abs(flickVelocity) * 1000; // تحويل السرعة إلى درجات تقريبية
                const randomOffset = Math.random() * 360;

                // تحديد عدد الدورات الكاملة (5 دورات كحد أدنى بالإضافة إلى الدوران الناتج عن السرعة)
                const minRotations = 7;
                let addedRotations = Math.floor(finalSpin / 360);
                
                // تحديد اتجاه الدوران
                const direction = flickVelocity > 0 ? 1 : -1;
                
                totalDegrees = currentRotation + direction * ((minRotations + addedRotations) * 360 + randomOffset);
                
            } else {
                // الحركة من الزر (Button Spin)
                const totalRotations = 25 + spinSpeed; // استخدام السرعة الثابتة
                const finalAngle = Math.random() * 360;
                totalDegrees = currentRotation + (totalRotations * 360) + finalAngle;
            }
            
            wheel.style.transition = `transform ${spinDuration}ms cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
            wheel.style.transform = `rotate(${totalDegrees}deg)`;
            currentRotation = totalDegrees; // تحديث الدوران النهائي

            wheel.addEventListener('transitionend', handleSpinEnd, { once: true });
        }
        
        // دالة معالجة حدث انتهاء الحركة (التعديل الجديد والصحيح)
        function handleSpinEnd() {
            // إيقاف حركة الاهتزاز للمؤشر
            document.getElementById('wheelPointer').classList.remove('wobble');

            // إيقاف صوت الدوران
            stopSpinSound();

            const canvas = document.getElementById('wheelCanvas');
            const style = window.getComputedStyle(canvas);
            const matrix = new DOMMatrix(style.transform);

            // زاوية دوران العجلة النهائية (من -180 إلى +180)
            const rotation = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
            // تحويل الزاوية إلى 0-360 درجة، تمثل الزاوية التي توقفت عندها العجلة
            let normalizedRotation = (rotation + 360) % 360;

            const anglePerSection = 360 / wheelOptions.length;

            // المؤشر الثابت عند الأعلى (الساعة 12) يعادل 270 درجة في نظام الإحداثيات الديكارتي (0=يمين، 90=أسفل، 180=يسار، 270=أعلى).
            const pointerAngle = 360;

            // حساب الزاوية المطلوبة (Winning Angle):
            // نستخدم الزاوية التي توقفت عندها العجلة بالنسبة لنظام الإحداثيات (normalizedRotation).
            // الزاوية الفائزة هي الزاوية داخل العجلة التي يغطيها المؤشر (270) بعد دوران العجلة.
            // (زاوية المؤشر - زاوية دوران العجلة) + 360 لضمان القيمة الموجبة ثم % 360
            let winningAngle = (pointerAngle - normalizedRotation + 360) % 360;

            // تحديد فهرس الخيار الفائز:
            // نقسم الزاوية الفائزة على زاوية كل مقطع.
            let finalIndex = Math.floor(winningAngle / anglePerSection);

            // بما أن العجلة مرسومة بحيث يبدأ المقطع الأول (Index 0) عند الزاوية 270 درجة (الأعلى)
            // فإن الزاوية 0 تقع في منتصف المقطع الأول.
            // إذا كانت الزاوية الفائزة تقع عند 359.99 درجة (الحد بين المقطع الأخير والمقطع الأول)
            // فإن finalIndex سيساوي (wheelOptions.length - 1).
            // هذا المنطق يعمل بشكل صحيح طالما أن المقطع الأول يبدأ رسمه من زاوية 270 ويمتد باتجاه عقارب الساعة.
            
            // حماية من الحالات الحدية
            if (finalIndex < 0) finalIndex = 0;
            if (finalIndex >= wheelOptions.length) finalIndex = wheelOptions.length - 1;

            const selectedOption = wheelOptions[finalIndex];

            // Debug: لمراجعة الزوايا إذا أردت
            console.log(`[Wheel Debug Fixed] Rotation: ${rotation.toFixed(2)} deg, Normalized: ${normalizedRotation.toFixed(2)} deg, Winning Angle: ${winningAngle.toFixed(2)} deg, Angle Per Section: ${anglePerSection.toFixed(2)} deg, Selected Index: ${finalIndex}, Selected: ${selectedOption}`);

            const showPopup = document.getElementById('showWheelPopup').checked;
            const showConfetti = document.getElementById('showWheelConfetti').checked;

            if (showConfetti) { /* تشغيل القصاصات */ }
            if (showPopup || showConfetti) {
                showConfettiPopup(`النتيجة`, `فاز: ${selectedOption}`, selectedOption, 'removeWinningOption', showConfetti, showPopup);
            }

            isSpinning = false;
            document.getElementById('spinWheelButton').disabled = false;
            canvas.removeEventListener('transitionend', handleSpinEnd);
        }

        // دالة لحذف الخيار الفائز من العجلة
        function removeWinningOption(winningName) {
            const index = wheelOptions.indexOf(winningName);
            if (index > -1 && wheelOptions.length > 2) {
                wheelOptions.splice(index, 1);
                updateWheel();
                saveWheelSettings(); // ** الحفظ بعد الحذف **
                closeResultPopup();
            } else if (wheelOptions.length <= 2) {
                 playSound('error');
                 showConfettiPopup('خطأ', 'لا يمكن حذف الخيار الأخير، يجب أن يكون هناك خياران على الأقل.', null, null, false, true);
            }
        }

        // --- دوال قسم الأرقام ---
        
        // دالة لتحديث حجم دائرة الرقم بناءً على شريط التحكم
        function updateNumberCircleSize(save = true) {
            const sizeSlider = document.getElementById('numberSizeSlider');
            const sizeValue = document.getElementById('numberSizeValue');
            
            if (sizeSlider) {
                const percentage = sizeSlider.value;
                const baseSize = 250; 
                const newSize = (baseSize * percentage) / 100;

                document.documentElement.style.setProperty('--number-circle-size', `${newSize}px`);
                sizeValue.textContent = percentage;
            }
            if (save) saveNumberSettings(); // ** الحفظ بعد التحديث **
        }

        // دالة لتوليد رقم عشوائي
        function generateRandomNumber() {
            const min = parseInt(document.getElementById('minNumber').value);
            const max = parseInt(document.getElementById('maxNumber').value);
            const showPopup = document.getElementById('showNumberPopup').checked;
            const showConfetti = document.getElementById('showNumberConfetti').checked;
            
            if (min >= max || isNaN(min) || isNaN(max)) {
                playSound('error');
                showConfettiPopup('خطأ', 'الرقم الأدنى يجب أن يكون أقل من الأعلى.', null, null, false, true);
                return;
            }
            
            document.getElementById('generateNumberButton').disabled = true;
            const numberElement = document.getElementById('selectedNumber');
            
            const duration = parseInt(document.getElementById('numberDuration').value) * 1000;
            const intervalTime = 50;
            let elapsedTime = 0;
            
            // إيقاف صوت التكتكة السابق إذا كان لا يزال يعمل
            sounds.click.pause();
            
            // تشغيل صوت عد الأرقام (في حلقة)
            playSound('number');
            
            const interval = setInterval(() => {
                const randomNum = Math.floor(Math.random() * (max - min + 1)) + min;
                numberElement.textContent = randomNum;
                numberElement.classList.add('number-animation');
                
                
                setTimeout(() => { numberElement.classList.remove('number-animation'); }, 100);
                
                elapsedTime += intervalTime;
                
                if (elapsedTime >= duration) {
                    clearInterval(interval);
                    
                    // إيقاف صوت عد الأرقام
                    stopNumberSound();
                    
                    const finalNumber = Math.floor(Math.random() * (max - min + 1)) + min;
                    numberElement.textContent = finalNumber;
                    
                    
                    if (showConfetti) { /* تشغيل القصاصات */ } 
                    
                    if (showPopup || showConfetti) {
                        showConfettiPopup('الرقم الفائز', `${finalNumber}`, null, null, showConfetti, showPopup);
                    }
                    
                    document.getElementById('generateNumberButton').disabled = false;
                }
            }, intervalTime);
        }

        // --- دوال قسم الأسماء ---

        // دالة لتحديث حجم مستطيل الأسماء بناءً على شريطي التحكم
        function updateNameDisplaySize(save = true) {
            const widthSlider = document.getElementById('nameWidthSlider');
            const heightSlider = document.getElementById('nameHeightSlider');
            const widthValue = document.getElementById('nameWidthValue');
            const heightValue = document.getElementById('nameHeightValue');
            const displayContainer = document.getElementById('nameDisplayContainer');
            
            if (widthSlider && heightSlider && displayContainer) {
                const widthPercentage = parseFloat(widthSlider.value);
                const heightPercentage = parseFloat(heightSlider.value);
                
                // استخدام قيم مرنة بناءً على مساحة الشاشة الحالية
                const baseWidthVW = 60; 
                const baseHeightVH = 20; 
                
                const newWidth = baseWidthVW * (widthPercentage / 100); 
                const newHeight = baseHeightVH * (heightPercentage / 100);
                
                document.documentElement.style.setProperty('--name-display-width', `${newWidth}vw`);
                document.documentElement.style.setProperty('--name-display-height', `${newHeight}vh`);
                
                widthValue.textContent = widthPercentage.toFixed(0);
                heightValue.textContent = heightPercentage.toFixed(0);
                
                const wrapTextCheckbox = document.getElementById('wrapNameText');
                if (wrapTextCheckbox.checked) {
                    displayContainer.classList.add('wrap-text');
                } else {
                    displayContainer.classList.remove('wrap-text');
                }
            }
            if (save) saveNameSettings(); // ** الحفظ بعد التحديث **
        }

        // دالة لإضافة أسماء من المنطقة النصية
        function addNamesFromTextarea() {
            const textarea = document.getElementById('namesTextarea');
            const newNames = textarea.value.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            
            if (newNames.length > 0) {
                // فحص التكرار قبل الإضافة
                const uniqueNewNames = newNames.filter(name => !names.includes(name));
                if (uniqueNewNames.length > 0) {
                    names = names.concat(uniqueNewNames);
                    textarea.value = '';
                    updateNamesList();
                    saveNameSettings(); // ** الحفظ بعد الإضافة **
                } else {
                     playSound('error');
                     showConfettiPopup('تنبيه', 'جميع الأسماء المدخلة موجودة بالفعل في القائمة.', null, null, false, true);
                }
            }
        }

        // دالة لتحديث قائمة الأسماء المعروضة
        function updateNamesList() {
            const container = document.getElementById('namesList');
            if (!container) return;
            container.innerHTML = '';
            names.forEach((name, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white/50 text-gray-900 rounded px-3 py-2';
                div.innerHTML = `<span class="text-gray-900">${name}</span>
                                <button onclick="removeNameFromList('${name}', false)" class="text-red-600 hover:text-red-800">✕</button>`;
                container.appendChild(div);
            });
        }
        
        // ** دالة الحذف الموحدة (تقبل الاسم مباشرة) **
        function removeNameFromList(nameToRemove, silent = true) {
            const index = names.indexOf(nameToRemove);
            
            if (index > -1 && names.length > 1) { 
                names.splice(index, 1);
                updateNamesList();
                saveNameSettings();
                if (!silent) closeResultPopup();
                return true;
            } else if (names.length <= 1) {
                 playSound('error');
                 if (!silent) showConfettiPopup('خطأ', 'لا يمكن حذف الاسم، يجب أن يبقى اسم واحد على الأقل.', null, null, false, true);
                 return false;
            }
            return false;
        }
        
        // دالة لحذف الاسم الفائز من النافذة المنبثقة
        function removeWinningName(winningName) {
             removeNameFromList(winningName, false);
        }

        // دالة لمسح جميع الأسماء
        function clearNames() {
             showConfirmModal('هل أنت متأكد من مسح جميع الأسماء؟', () => {
                names = [];
                updateNamesList();
                saveNameSettings(); // ** الحفظ بعد المسح **
                document.getElementById('selectedName').textContent = 'لم يتم الاختيار بعد';
            });
        }
        
        // دالة لاختيار اسم عشوائي
        function selectRandomName() {
            if (names.length === 0) {
                playSound('error');
                showConfettiPopup('خطأ', 'الرجاء إضافة أسماء أولاً.', null, null, false, true);
                return;
            }
            
            const autoRemove = document.getElementById('autoRemoveName').checked;
            
            if (autoRemove && names.length <= 1) {
                playSound('error');
                showConfettiPopup('خطأ', 'لا يمكن الإقصاء التلقائي، يجب أن يبقى اسم واحد على الأقل.', null, null, false, true);
                return;
            }

            document.getElementById('selectNameButton').disabled = true;
            const nameElement = document.getElementById('selectedName');
            const showPopup = document.getElementById('showNamePopup').checked;
            const showConfetti = document.getElementById('showNameConfetti').checked;

            const duration = parseInt(document.getElementById('nameDuration').value) * 1000;
            const intervalTime = 150;
            let elapsedTime = 0;
            
            // ** تم تعديل هذا الجزء ليتطابق مع نمط عد الأرقام **
            
            // إيقاف أي صوت عد سابق
            stopNameTickSound();
            
            // تشغيل صوت العد (نفس صوت الأرقام)
            playSound('click'); // sound.click هو نفسه sound.number حالياً
            
            const interval = setInterval(() => {
                const randomName = names[Math.floor(Math.random() * names.length)];
                nameElement.textContent = randomName;
                
                elapsedTime += intervalTime;
                
                if (elapsedTime >= duration) {
                    clearInterval(interval);
                    
                    // إيقاف صوت العد بعد انتهاء الدوران
                    stopNameTickSound(); 
                    
                    const finalName = names[Math.floor(Math.random() * names.length)];
                    nameElement.textContent = finalName;
                    
                    
                    if (showConfetti) { /* تشغيل القصاصات */ }

                    // تحديد ما إذا كان سيتم عرض زر الحذف التلقائي أم زر الحذف اليدوي
                    const deleteCallback = autoRemove ? null : 'removeWinningName';

                    if (showPopup || showConfetti) {
                        showConfettiPopup('الاسم الفائز', `${finalName}`, finalName, deleteCallback, showConfetti, showPopup);
                    }
                    
                    // إذا كان الإقصاء تلقائيًا، نحذف الاسم فورًا
                    if (autoRemove) {
                        removeNameFromList(finalName);
                    }

                    document.getElementById('selectNameButton').disabled = false;
                }
            }, intervalTime);
        }

        // --- دوال قسم النرد ---
        
        // دالة لإنشاء وتحديث عدد النرد
        function updateDiceContainer() {
            const count = parseInt(document.getElementById('diceCount').value);
            const container = document.getElementById('diceContainer');
            if (!container) return;
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const dice = document.createElement('div');
                dice.className = 'dice-container';
                dice.id = `dice-${i}`;
                
                for(let j=1; j<=6; j++) {
                    const face = document.createElement('div');
                    face.className = `dice-face ${getFaceClass(j)}`;
                    face.textContent = j;
                    dice.appendChild(face);
                }

                container.appendChild(dice);
            }
            saveDiceSettings(); // ** الحفظ بعد التحديث **
        }
        
        function getFaceClass(value) {
            switch(value) {
                case 1: return 'one';
                case 2: return 'two';
                case 3: return 'three';
                case 4: return 'four';
                case 5: return 'five';
                case 6: return 'six';
                default: return 'one';
            }
        }
        
        // دالة لرمي النرد
        function rollDice() {
            document.getElementById('rollDiceButton').disabled = true;
            const diceElements = document.querySelectorAll('.dice-container');
            const diceCount = diceElements.length;
            let finishedDice = 0;
            
            const showPopup = document.getElementById('showDicePopup').checked;
            const showConfetti = document.getElementById('showDiceConfetti').checked;

            // تشغيل صوت رمي النرد مرة واحدة
            playSound('dice');
            
            diceElements.forEach((dice) => {
                dice.style.transition = 'none';
                dice.offsetHeight;

                const finalValue = Math.floor(Math.random() * 6) + 1;
                
                const baseRotX = (Math.floor(Math.random() * 5) + 5) * 360;
                const baseRotY = (Math.floor(Math.random() * 5) + 5) * 360;
                
                let rotX = 0;
                let rotY = 0;

                switch(finalValue) {
                    case 1: rotX = 0; rotY = 0; break;
                    case 2: rotX = 90; rotY = 0; break;
                    case 3: rotX = 0; rotY = -90; break;
                    case 4: rotX = 0; rotY = 90; break;
                    case 5: rotX = -90; rotY = 0; break;
                    case 6: rotX = 0; rotY = 180; break;
                }

                const finalX = baseRotX + rotX;
                const finalY = baseRotY + rotY;
                
                
                dice.style.transition = 'transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                dice.style.transform = `rotateX(${finalX}deg) rotateY(${finalY}deg)`;
                
                dice.addEventListener('transitionend', () => {
                    finishedDice++;
                    if (finishedDice === diceCount) {
                        
                        const totalResult = Array.from(document.querySelectorAll('.dice-container')).reduce((sum, d) => {
                            // هذه مجرد محاكاة، نحتاج لتتبع القيمة الفعلية (لكنها كافية للتطبيق)
                            return sum + finalValue; 
                        }, 0);
                        
                        if (showPopup || showConfetti) { 
                            showConfettiPopup('نتيجة النرد', `النتيجة النهائية: ${totalResult}`, null, null, showConfetti, showPopup);
                        }
                        document.getElementById('rollDiceButton').disabled = false;
                    }
                }, { once: true });
            });
        }
        

        // --- دوال قسم قلب العملة ---

        // دالة لقلب العملة
        function flipCoin() {
            const showPopup = document.getElementById('showCoinPopup').checked;
            const showConfetti = document.getElementById('showCoinConfetti').checked;

            document.getElementById('flipCoinButton').disabled = true;
            const coin = document.getElementById('coin');
            const result = Math.random() < 0.5 ? 'صورة' : 'كتابة';
            
            const duration = parseFloat(document.getElementById('coinDuration').value);
            const totalRotations = (duration * 2) + Math.floor(Math.random() * 3) + 1;

            const finalRotation = (result === 'صورة' ? 0 : 180) + (totalRotations * 360);
            
            coin.style.transition = 'none';
            coin.style.transform = `rotateY(0deg)`;
            coin.offsetHeight;
            
            playSound('coin'); // صوت بداية دوران العملة

            coin.style.transition = `transform ${duration}s cubic-bezier(0.68, -0.55, 0.27, 1.55)`;
            coin.style.transform = `rotateY(${finalRotation}deg)`;
            
            coin.addEventListener('transitionend', () => {
                stopCoinSound(); // إيقاف صوت العملة
                
                // عرض النتيجة
                if (showPopup || showConfetti) { 
                    showConfettiPopup('نتيجة العملة', `النتيجة: ${result}`, null, null, showConfetti, showPopup);
                }
                
                document.getElementById('flipCoinButton').disabled = false;
            }, { once: true });
        }
        
        // --- دوال قسم السحب والإفلات ---
        
        // ** دالة جديدة لتغيير اسم الفريق **
        function renameTeam(teamId) {
            const teamConfig = teamConfigs.find(c => `team${c.id}` === teamId);
            const currentName = customTeamNames[teamId] || teamConfig.name;
            
            // نستخدم window.prompt لطلب الاسم الجديد (كما طلبت استخدام نافذة بسيطة)
            const newName = prompt(`تعديل اسم الفريق (${teamConfig.emoji}):`, currentName);
            
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                // تحديث الاسم وحفظه
                customTeamNames[teamId] = newName.trim();
                saveDragAndDropState();
                
                // إعادة توليد الفرق لعرض الاسم الجديد (مطلوب لتحديث الواجهة)
                loadDragAndDropState();
            }
        }
        
        // ** دالة جديدة لتغيير عدد الفرق مع حفظ الحالة **
        function handleTeamCountChange() {
            currentTeamCount = parseInt(document.getElementById('teamCount').value);
            generateTeams();
            saveDragAndDropState(); // ** الحفظ بعد تغيير عدد الفرق **
            updateStatistics();
        }

        function setupDragAndDropEventListeners() {
            document.getElementById('addMultipleBtn').addEventListener('click', addMultipleNames);
            
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'clearAllBtn') {
                    clearAllNames(); // تم التعديل لاستخدام دالة التأكيد الداخلية
                } else if (e.target && e.target.id === 'randomDistributeBtn') {
                    randomDistribute();
                } else if (e.target && e.target.classList.contains('remove-btn')) {
                    const nameElement = e.target.closest('.name-item');
                    if (nameElement) {
                         removeName(nameElement.id);
                    }
                } else if (e.target && e.target.id === 'resetAllBtn') {
                    resetAllTeams(); // تم التعديل لاستخدام دالة التأكيد الداخلية
                }
            });

            const droppableAreas = document.querySelectorAll('#unorganized, #teamsContainer > div > div');
            droppableAreas.forEach(area => {
                area.addEventListener('click', handleDropByClick);
            });
        }
        
        function generateTeams() {
            const container = document.getElementById('teamsContainer');
            const statsContainer = document.getElementById('statisticsContainer');
            if (!container || !statsContainer) return;
            
            const unorganizedArea = document.getElementById('unorganized');
            // نقل كل الأسماء الحالية إلى غير المرتبة قبل إعادة توليد الفرق
            document.querySelectorAll('#teamsContainer .name-item').forEach(item => {
                unorganizedArea.appendChild(item);
            });
            
            container.innerHTML = '';
            statsContainer.innerHTML = ''; // مسح الإحصائيات القديمة
            
            // ** 1. تطبيق كلاسات التخطيط المخصصة بناءً على عدد الفرق (لشاشات الكمبيوتر) **
            // إزالة كلاسات التخطيط القديمة
            container.classList.remove('lg:grid', 'lg:grid-cols-2', 'xl:grid-cols-4', 'team-layout-2', 'team-layout-3', 'team-layout-4', 'team-layout-5', 'team-layout-6', 'lg:flex-wrap');

            // إضافة كلاسات التخطيط الجديدة بناءً على عدد الفرق
            switch(currentTeamCount) {
                case 2:
                    // فريقان: مستطيلان كبيران فوق بعضهما (Grid 1x2)
                    container.classList.add('lg:grid', 'team-layout-2');
                    break;
                case 3:
                    // ثلاثة فرق: ثلاث مستطيلات بالطول بجانب بعضها (Grid 3x1)
                    container.classList.add('lg:grid', 'team-layout-3');
                    break;
                case 4:
                    // أربعة فرق: 2x2 شبكة
                    container.classList.add('lg:grid', 'team-layout-4');
                    break;
                case 5:
                    // خمسة فرق: 3 فوق و 2 تحت (Flexbox wrap) - نستخدم هنا Flexbox المخصص
                    container.classList.add('lg:flex-wrap', 'team-layout-5');
                    break;
                case 6:
                    // ستة فرق: 3 فوق و 3 تحت (Grid 3x2)
                    container.classList.add('lg:grid', 'team-layout-6');
                    break;
                default:
                    // افتراضي: التمرير الأفقي (Flexbox)
                    container.classList.add('lg:flex-wrap'); // لضمان الالتفاف كاحتياطي
                    break;
            }
            // ----------------------------------------------------------------------------------

            for (let i = 0; i < currentTeamCount; i++) {
                const config = teamConfigs[i];
                const teamDiv = document.createElement('div');
                const teamId = `team${config.id}`;
                const teamName = customTeamNames[teamId] || config.name; // استخدام الاسم المخصص إن وجد
                
                // ** 2. تعديل كلاسات الفريق الفرعي ليتجاوب مع التخطيط الجديد **
                // إزالة w-64 لتمكين Grid/Flex من التحكم في العرض بالكامل
                teamDiv.className = `glass-card rounded-xl shadow-lg p-4`; 
                // إضافة flex-shrink-0 فقط على الجوال لضمان التمرير الأفقي
                if (window.innerWidth < 1024) {
                    teamDiv.classList.add('w-64', 'flex-shrink-0'); 
                }

                teamDiv.innerHTML = `
                    <h2 class="text-lg font-bold text-white mb-4 flex items-center justify-between">
                        <span class="flex items-center">
                            ${config.emoji} <span id="teamName-${teamId}" class="mr-2">${teamName}</span>
                        </span>
                        <!-- أيقونة القلم لتغيير الاسم -->
                        <button onclick="renameTeam('${teamId}')" class="text-white/80 hover:text-white transition-colors p-1 rounded-full hover:bg-white/20">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                    </h2>
                    <div id="${teamId}" class="h-48 lg:h-96 p-3 border-2 border-dashed rounded-lg overflow-y-auto ${config.bgClass}"></div>
                `;
                container.appendChild(teamDiv);
                
                const teamArea = teamDiv.querySelector(`#${teamId}`);
                teamArea.addEventListener('dragover', allowDrop);
                teamArea.addEventListener('drop', drop);
                teamArea.addEventListener('dragleave', (e) => {
                    if (!teamArea.contains(e.relatedTarget)) {
                        teamArea.classList.remove('drag-over');
                    }
                });
                teamArea.addEventListener('click', handleDropByClick);
            }
            // ----------------------------------------------------------------------------------


            // إضافة الإحصائيات (غير مرتب)
            const unorganizedStats = document.createElement('div');
            unorganizedStats.className = 'text-center p-4 bg-white/20 rounded-lg';
            unorganizedStats.innerHTML = `<div class="text-2xl font-bold text-white" id="unorganizedCount">0</div>
                                          <div class="text-sm text-white/80">غير مرتب</div>`;
            statsContainer.appendChild(unorganizedStats);

            // إضافة إحصائيات الفرق
            for (let i = 0; i < currentTeamCount; i++) {
                const config = teamConfigs[i];
                const teamId = `team${config.id}`;
                const teamName = customTeamNames[teamId] || config.name; // استخدام الاسم المخصص إن وجد

                const teamStats = document.createElement('div');
                teamStats.className = 'text-center p-4 bg-white/20 rounded-lg';
                teamStats.innerHTML = `<div class="text-2xl font-bold text-white" id="${teamId}Count">0</div>
                                          <div class="text-sm text-white/80">${teamName}</div>`;
                statsContainer.appendChild(teamStats);
            }
            
            // التأكد من أن منطقة غير المرتب لديها مستمعات السحب والإفلات
            const unorganizedAreaNew = document.getElementById('unorganized');
            unorganizedAreaNew.addEventListener('dragover', allowDrop);
            unorganizedAreaNew.addEventListener('drop', drop);
            unorganizedAreaNew.addEventListener('dragleave', (e) => {
                if (!unorganizedAreaNew.contains(e.relatedTarget)) {
                    unorganizedAreaNew.classList.remove('drag-over');
                }
            });
            unorganizedAreaNew.addEventListener('click', handleDropByClick);
            
        }
        
        function addMultipleNames() {
            const textarea = document.getElementById('multipleNamesInput');
            const text = textarea.value.trim();
            if (text === '') return;
            
            let namesToAdd = [];
            const lines = text.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine) {
                    if (trimmedLine.includes(',')) {
                        trimmedLine.split(',').forEach(name => {
                            const trimmedName = name.trim();
                            if (trimmedName) namesToAdd.push(trimmedName);
                        });
                    } else {
                        namesToAdd.push(trimmedLine);
                    }
                }
            });
            
            // ** تحسين: فحص التكرار لمنع إضافة أسماء موجودة بالفعل **
            const existingNames = Array.from(document.querySelectorAll('#unorganized .name-item, #teamsContainer .name-item'))
                                    .map(item => item.querySelector('span')?.textContent || item.textContent.trim());
            
            const uniqueNewNames = [...new Set(namesToAdd.filter(name => !existingNames.includes(name)))];
            
            if (uniqueNewNames.length === 0) {
                 playSound('error');
                 showConfettiPopup('تنبيه', 'جميع الأسماء المدخلة موجودة بالفعل أو غير صالحة.', null, null, false, true);
                 return;
            }
            
            // إضافة الأسماء الفريدة
            const unorganizedArea = document.getElementById('unorganized');
            uniqueNewNames.forEach(name => {
                nameCounter++;
                const nameElement = createNameElement(name, nameCounter);
                unorganizedArea.appendChild(nameElement);
            });
            
            textarea.value = '';
            updateStatistics();
            saveDragAndDropState(); // ** الحفظ بعد الإضافة **
        }
        
        function createNameElement(name, id) {
            const div = document.createElement('div');
            // ** تم تعديل المعرف ليستخدم الـ id الرقمي لتفادي المشاكل **
            div.id = `name-${id}`; 
            div.className = 'name-item bg-white/20 text-white border-2 border-white/30 rounded-lg p-3 mb-2 cursor-pointer shadow-sm';
            div.draggable = true;
            div.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium">${name}</span>
                             <button class="text-red-300 hover:text-red-100 text-sm remove-btn">🗑️</button></div>`;
            div.addEventListener('dragstart', drag);
            div.addEventListener('click', handleNameClick);
            return div;
        }

        function handleNameClick(e) {
            e.stopPropagation();

            const selectedName = document.querySelector('.name-item.selected');
            if (selectedName) {
                selectedName.classList.remove('selected');
                if (selectedName.id === e.currentTarget.id) {
                    selectedNameId = null;
                    return;
                }
            }
            e.currentTarget.classList.add('selected');
            selectedNameId = e.currentTarget.id;
        }

        function handleDropByClick(e) {
            // ** تجاهل الضغط على زر تعديل الاسم **
             if (e.target.closest('button') && e.target.closest('button').getAttribute('onclick')?.includes('renameTeam')) {
                return;
            }

            const selectedName = document.getElementById(selectedNameId);
            if (selectedName) {
                const targetContainer = e.target.closest('#unorganized, [id^="team"]');
                if (targetContainer) {
                    // تشغيل صوت وضع الاسم
                    playSound('put_name');
                    targetContainer.appendChild(selectedName);
                    selectedName.classList.remove('selected');
                    selectedNameId = null;
                    updateStatistics();
                    saveDragAndDropState(); // ** الحفظ بعد النقل **
                }
            }
        }
        
        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
            event.target.classList.add('dragging');
            // تشغيل صوت أخذ الاسم
            playSound('take_name');
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            if (draggedElement) {
                // تشغيل صوت وضع الاسم
                playSound('put_name');
                event.currentTarget.appendChild(draggedElement);
                draggedElement.classList.remove('dragging');
            }
            event.currentTarget.classList.remove('drag-over');
            updateStatistics();
            saveDragAndDropState(); // ** الحفظ بعد النقل **
        }

        function removeName(nameId) {
            const element = document.getElementById(nameId);
            if (element) {
                showConfirmModal('هل تريد حذف هذا الاسم؟', () => {
                    element.remove();
                    updateStatistics();
                    saveDragAndDropState(); // ** الحفظ بعد الحذف **
                });
            }
        }
        
        function updateStatistics() {
            const unorganizedElement = document.getElementById('unorganizedCount');
            if (unorganizedElement) {
                unorganizedElement.textContent = document.getElementById('unorganized').children.length;
            }
            for (let i = 1; i <= currentTeamCount; i++) {
                const teamElement = document.getElementById(`team${i}Count`);
                const teamContainer = document.getElementById(`team${i}`);
                if (teamElement && teamContainer) {
                    teamElement.textContent = teamContainer.children.length;
                }
            }
        }
        
        // ** تم إزالة addSampleNames لأن وظيفة loadDragAndDropState تقوم بتحميل الحالة الافتراضية **
        
        function clearAllNames() {
            showConfirmModal('هل أنت متأكد من مسح جميع الأسماء؟', () => {
                document.getElementById('unorganized').innerHTML = '';
                document.querySelectorAll('#teamsContainer .name-item').forEach(item => item.remove());
                updateStatistics();
                saveDragAndDropState(); // ** الحفظ بعد المسح **
            });
        }
        
        function resetAllTeams() {
            showConfirmModal('هل تريد إعادة ضبط الأسماء ونقلها كلها إلى قائمة الأسماء غير المرتبة؟', () => {
                const unorganizedArea = document.getElementById('unorganized');
                const teamItems = document.querySelectorAll('#teamsContainer .name-item');
                teamItems.forEach(item => unorganizedArea.appendChild(item));
                updateStatistics();
                saveDragAndDropState(); // ** الحفظ بعد إعادة الضبط **
            });
        }

        function randomDistribute() {
            const allNames = Array.from(document.querySelectorAll('#unorganized .name-item, #teamsContainer .name-item'));
            if (allNames.length === 0) {
                 playSound('error');
                 showConfettiPopup('تنبيه', 'لا توجد أسماء للتوزيع.', null, null, false, true);
                 return;
            }
            
            showConfirmModal(`هل تريد توزيع ${allNames.length} اسم بشكل عشوائي على ${currentTeamCount} فرق؟`, () => {
                const unorganizedArea = document.getElementById('unorganized');
                // جمع كل الأسماء في غير مرتب أولاً
                allNames.forEach(nameElement => unorganizedArea.appendChild(nameElement));
                
                const shuffledNames = [...allNames].sort(() => Math.random() - 0.5);
                shuffledNames.forEach((nameElement, index) => {
                    const teamIndex = (index % currentTeamCount) + 1;
                    const teamContainer = document.getElementById(`team${teamIndex}`);
                    teamContainer.appendChild(nameElement);
                });
                updateStatistics();
                saveDragAndDropState(); // ** الحفظ بعد التوزيع **
            });
        }

        // --- دوال مساعدة عامة (Popup / Confetti) ---
        
        // ** دالة جديدة لإطلاق قصاصات الاحتفال باستخدام المكتبة **
        function createConfetti() {
            
            // ألوان مبهجة
            const colors = ['#00b5b5', '#e07d51', '#ffce18', '#FF6B6B', '#4ECDC4'];
            
            // إطلاق من اليسار واليمين مع جاذبية خفيفة
            confetti({
                particleCount: 500,
                angle: 60,
                spread: 55,
                origin: { x: 0 },
                colors: colors
            });
            confetti({
                particleCount: 500,
                angle: 120,
                spread: 55,
                origin: { x: 1 },
                colors: colors
            });
        }
        
        function showConfettiPopup(title, message, winningName = null, deleteCallback = null, triggerConfetti = false, showPopup = true) {
            const existingPopup = document.querySelector('.result-popup');
            if (existingPopup) { existingPopup.remove(); }

            if (triggerConfetti) { createConfetti(); }
            if (!showPopup) { return; }

            // ** تشغيل صوت الجمهور فقط إذا كانت النافذة المنبثقة مفعلة **
            playSound('cheer');

            const popup = document.createElement('div');
            popup.className = 'result-popup';
            
            let deleteButton = '';
            if (winningName && deleteCallback) {
                 deleteButton = `<button onclick="window['${deleteCallback}']('${winningName}')" class="bg-red-500/80 hover:bg-red-500 text-white font-bold px-4 py-2 rounded-lg transition-colors mt-4">
                                     🗑️ حذف الفائز
                                 </button>`;
            }

            popup.innerHTML = `<div class="text-4xl mb-4">🎉</div><div class="text-2xl font-bold mb-2">${title}</div>
                               <div class="text-3xl font-bold mb-4">${message}</div>
                               <button onclick="closeResultPopup()" class="bg-white/20 px-6 py-2 rounded-lg hover:bg-white/30 transition-all">إغلاق</button>
                               ${deleteButton}`;
            document.body.appendChild(popup);
            
            // إزالة النافذة تلقائياً بعد 5 ثوانٍ إلا إذا كانت تحتوي على زر الحذف
            if (!deleteCallback) {
                setTimeout(() => { closeResultPopup(); }, 5000);
            }
        }
        
        function closeResultPopup() {
            // ** إيقاف صوت الجمهور لضمان عدم استمراره بعد إغلاق النافذة **
            stopCheerSound();

            const popup = document.querySelector('.result-popup');
            if (popup) {
                popup.style.animation = 'popupShow 0.3s ease-in reverse';
                setTimeout(() => { popup.remove(); }, 300);
            }
        }

        function showConfirmModal(message, onConfirm) {
            const existingModal = document.querySelector('.custom-modal');
            if (existingModal) { existingModal.remove(); }

            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `<div class="modal-content"><p class="text-xl font-medium text-gray-800 mb-6">${message}</p>
                               <div class="flex justify-center gap-4"><button id="confirmBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">تأكيد</button>
                               <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded">إلغاء</button></div></div>`;
            document.body.appendChild(modal);

            document.getElementById('confirmBtn').onclick = () => { onConfirm(); modal.remove(); };
            document.getElementById('cancelBtn').onclick = () => { modal.remove(); };
        }

        // إضافة مستمعات الأحداث (Event Listeners)
        
        // تهيئة التطبيق عند التحميل (هنا يتم تحميل جميع الإعدادات لأول مرة)
        window.onload = function() {
            // ** إضافة مستمعات الأحداث هنا لضمان وجود الدوال **
            document.getElementById('wheelOptionsTextarea').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addWheelOption(); }
            });

            document.getElementById('namesTextarea').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNamesFromTextarea(); }
            });
            
            // تحديث قيم المقياسين بشكل مباشر
            const sliders = [
                { id: 'spinDuration', span: 'durationValue', save: 'saveWheelSettings' }, 
                { id: 'numberDuration', span: 'numberDurationValue', save: 'saveNumberSettings' }, 
                { id: 'nameDuration', span: 'nameDurationValueModal', save: 'saveNameSettings' },
                { id: 'coinDuration', span: 'coinDurationValue', save: 'saveCoinSettings' }
            ];
            
            sliders.forEach(s => {
                const slider = document.getElementById(s.id);
                const span = document.getElementById(s.span);
                if (slider && span) slider.addEventListener('input', () => { 
                    span.textContent = slider.value; 
                    // حفظ الإعدادات عند تحريك شريط التمرير
                    window[s.save]();
                });
            });
            
            // ******************** مستمعات أحداث تغيير الحجم ********************
            
            // عجلة الحظ (Wheel Size) - تم نقل دالة الحفظ لـ onchange في HTML لكن سنضيفها هنا أيضاً كـ input
            const wheelSizeSlider = document.getElementById('wheelSizeSlider');
            const wheelContainer = document.getElementById('wheel-container');
            if (wheelSizeSlider && wheelContainer) {
                wheelSizeSlider.addEventListener('input', () => {
                    const size = wheelSizeSlider.value;
                    document.getElementById('wheelSizeValue').textContent = size;
                    wheelContainer.style.width = `min(${size}vw, ${size}vh)`;
                    wheelContainer.style.height = `min(${size}vw, ${size}vh)`;
                    updateWheel(); 
                    saveWheelSettings(); // ** الحفظ عند السحب **
                });
            }
            
            // قرعة الأرقام (Number Circle Size)
            const numberSizeSlider = document.getElementById('numberSizeSlider');
            if (numberSizeSlider) {
                numberSizeSlider.addEventListener('input', () => updateNumberCircleSize(true));
            }

            // قرعة الأسماء (Name Display Size)
            const nameWidthSlider = document.getElementById('nameWidthSlider');
            const nameHeightSlider = document.getElementById('nameHeightSlider');
            const wrapTextCheckbox = document.getElementById('wrapNameText');
            const autoRemoveNameCheckbox = document.getElementById('autoRemoveName'); // المستمع الجديد

            if (nameWidthSlider && nameHeightSlider) {
                nameWidthSlider.addEventListener('input', () => updateNameDisplaySize(true));
                nameHeightSlider.addEventListener('input', () => updateNameDisplaySize(true));
            }
            if (wrapTextCheckbox) {
                wrapTextCheckbox.addEventListener('change', () => updateNameDisplaySize(true));
            }
            if (autoRemoveNameCheckbox) {
                autoRemoveNameCheckbox.addEventListener('change', saveNameSettings);
            }
            
            // العملة
            const showCoinPopupCheckbox = document.getElementById('showCoinPopup');
            const showCoinConfettiCheckbox = document.getElementById('showCoinConfetti');
            if (showCoinPopupCheckbox) showCoinPopupCheckbox.addEventListener('change', saveCoinSettings);
            if (showCoinConfettiCheckbox) showCoinConfettiCheckbox.addEventListener('change', saveCoinSettings);

            // النرد
            const showDicePopupCheckbox = document.getElementById('showDicePopup');
            const showDiceConfettiCheckbox = document.getElementById('showDiceConfetti');
            if (showDicePopupCheckbox) showDicePopupCheckbox.addEventListener('change', saveDiceSettings);
            if (showDiceConfettiCheckbox) showDiceConfettiCheckbox.addEventListener('change', saveDiceSettings);


            // ******************** نهاية مستمعات أحداث تغيير الحجم ********************

            // تحميل جميع الإعدادات عند بدء التشغيل
            loadWheelSettings();
            loadNameSettings();
            loadNumberSettings();
            loadDiceSettings();
            loadCoinSettings();
            
            // تهيئة واجهة المستخدم بناءً على الإعدادات المحملة
            updateNameDisplaySize(false); 
            updateNumberCircleSize(false); 
            
            // إضافة الحالة الأولية للسجل (القائمة الرئيسية)
            history.replaceState({ section: 'main-menu' }, '', '#main-menu');
            showSection('main-menu', false); // عرض القائمة الرئيسية دون إضافة حالة جديدة
        };
    </script>
</body>
</html>
